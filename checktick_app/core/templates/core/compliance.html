{% extends "base.html" %}
{% load static %}
{% block title %}{{ doc_title }} Â· Compliance Â· {{ block.super }}{% endblock %}
{% block content %}
<div class="grid grid-cols-12 gap-6">
  <aside class="col-span-12 lg:col-span-3 print:hidden">
    <div class="card bg-base-100 shadow sticky top-4">
      <div class="card-body p-4">
        <h2 class="card-title text-lg mb-2">
          <span class="mr-2">ðŸ“‹</span>
          DSPT Evidence
        </h2>
        <p class="text-xs text-base-content/60 mb-3">
          NHS Data Security and Protection Toolkit
        </p>
        <nav class="compliance-nav" style="max-height: calc(100vh - 14rem); overflow-y: auto;">
          {# Link to main documentation #}
          <div class="mb-3 pb-2 border-b border-base-300">
            <a href="{% url 'core:docs_index' %}"
               class="flex items-center text-sm px-2 py-1 rounded hover:bg-base-200 transition-colors text-primary">
              <span class="mr-2">ðŸ“š</span>
              Back to Documentation
            </a>
          </div>

          {% for item in pages %}
            {# Category with collapsible items #}
            <div class="docs-category mb-3" data-category="{{ item.title|slugify }}">
              <button class="docs-category-toggle w-full flex items-center justify-between text-left font-semibold text-sm px-2 py-1 rounded hover:bg-base-200 transition-colors"
                      aria-expanded="true"
                      aria-controls="category-{{ item.title|slugify }}">
                <span>
                  {% if item.icon %}<span class="mr-1">{{ item.icon }}</span>{% endif %}
                  {{ item.title }}
                </span>
                <svg class="docs-chevron w-4 h-4 transition-transform duration-200"
                     fill="none"
                     stroke="currentColor"
                     viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <ul class="docs-category-items menu menu-sm pl-2 mt-1"
                  id="category-{{ item.title|slugify }}"
                  style="display: block;">
                {% for page in item.pages %}
                  <li>
                    <a class="text-sm {% if active_slug == page.slug|slice:'11:' %}active font-semibold{% endif %}"
                       href="{% url 'core:compliance_page' slug=page.slug|slice:'11:' %}">
                      {{ page.title }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endfor %}
        </nav>
      </div>
    </div>
  </aside>
  <section class="col-span-12 lg:col-span-9">
    <div class="flex justify-end mb-4 print:hidden">
      <button id="print-btn" class="btn btn-ghost btn-sm gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
        </svg>
        Print / Save PDF
      </button>
    </div>
    <article class="prose max-w-none">
      <div id="print-header" class="hidden print:block mb-4 pb-4 border-b border-base-300">
        <p class="text-sm text-base-content/70 m-0">
          Printed from CheckTick DSPT Compliance Documentation<br>
          <span id="print-timestamp"></span>
        </p>
      </div>
      {{ html|safe }}
    </article>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/docs-navigation.js' %}" nonce="{{ request.csp_nonce }}"></script>
<script nonce="{{ request.csp_nonce }}">
  document.getElementById('print-btn').addEventListener('click', function() {
    // Set timestamp before printing
    var now = new Date();
    var timestamp = now.toLocaleDateString('en-GB', {
      day: 'numeric', month: 'long', year: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
    document.getElementById('print-timestamp').textContent = 'Generated: ' + timestamp;
    // Set document title for PDF filename
    var originalTitle = document.title;
    document.title = '{{ doc_title|escapejs }}';
    window.print();
    // Restore original title after print dialog
    setTimeout(function() { document.title = originalTitle; }, 100);
  });
</script>
{% endblock %}

{% block extra_css %}
<style nonce="{{ request.csp_nonce }}">
.compliance-nav::-webkit-scrollbar {
  width: 6px;
}

.compliance-nav::-webkit-scrollbar-track {
  background: transparent;
}

.compliance-nav::-webkit-scrollbar-thumb {
  background: oklch(var(--bc) / 0.2);
  border-radius: 3px;
}

.compliance-nav::-webkit-scrollbar-thumb:hover {
  background: oklch(var(--bc) / 0.3);
}

.docs-category-toggle:focus {
  outline: 2px solid oklch(var(--p));
  outline-offset: 2px;
}

.docs-category-items {
  transition: display 0.2s ease-in-out;
}

/* Print styles */
@media print {
  /* Hide navigation, header, footer, sidebar */
  aside,
  nav,
  header,
  footer,
  .navbar,
  .lg\:col-span-3,
  #print-btn,
  [class*="print:hidden"] {
    display: none !important;
  }

  /* Show print header */
  #print-header {
    display: block !important;
  }

  /* Full width content */
  .grid {
    display: block !important;
  }
  .col-span-12,
  .lg\:col-span-9,
  section {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  .prose {
    max-width: 100% !important;
  }

  /* Typography */
  body {
    font-size: 11pt;
    line-height: 1.4;
    background: white !important;
    color: black !important;
  }
  h1 { font-size: 18pt; }
  h2 { font-size: 14pt; page-break-after: avoid; }
  h3 { font-size: 12pt; page-break-after: avoid; }

  /* Links */
  a { text-decoration: underline; color: black !important; }
  a[href^="http"]:after {
    content: " (" attr(href) ")";
    font-size: 9pt;
    color: #666;
  }

  /* Avoid page breaks inside elements */
  pre, blockquote, table, ul, ol {
    page-break-inside: avoid;
  }
}
</style>
{% endblock %}
