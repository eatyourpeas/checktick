{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Backup Codes" %} - CheckTick{% endblock %}

{% block content %}
<div class="prose max-w-none">
  <h1 class="inline-flex items-center gap-2 text-base-content">
    {% include "components/icons/shield-check.html" with classes="w-6 h-6 text-base-content" only %}
    <span>{% trans "Backup Codes" %}</span>
  </h1>
</div>

<div class="mt-6 max-w-xl">
  <div class="alert alert-warning mb-6">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
    </svg>
    <div>
      <h3 class="font-bold">{% trans "Save these codes now!" %}</h3>
      <p class="text-sm">{% trans "These backup codes will only be shown once. Save them in a secure place like a password manager." %}</p>
    </div>
  </div>

  <div class="card bg-base-100 shadow">
    <div class="card-body">
      {% if is_initial_setup %}
      <div class="alert alert-success mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>{% trans "Two-factor authentication has been enabled!" %}</span>
      </div>
      {% else %}
      <div class="alert alert-info mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>{% trans "New backup codes generated. Your old codes are no longer valid." %}</span>
      </div>
      {% endif %}

      <h2 class="card-title text-base-content">{% trans "Your Backup Codes" %}</h2>
      <p class="opacity-80">
        {% trans "Use these codes if you lose access to your authenticator app. Each code can only be used once." %}
      </p>

      <div class="grid grid-cols-2 gap-3 mt-4 font-mono text-lg" id="backup-codes">
        {% for code in backup_codes %}
        <div class="bg-base-200 rounded-lg p-3 text-center select-all">
          {{ code }}
        </div>
        {% endfor %}
      </div>

      <div class="flex gap-3 mt-6">
        <button type="button" class="btn btn-outline" onclick="copyBackupCodes()">
          {% include "components/icons/copy.html" with classes="w-4 h-4 mr-2" only %}
          {% trans "Copy Codes" %}
        </button>
        <button type="button" class="btn btn-outline" onclick="printBackupCodes()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0l.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0021 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 00-1.913-.247M6.34 18H5.25A2.25 2.25 0 013 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 011.913-.247m10.5 0a48.536 48.536 0 00-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5zm-3 0h.008v.008H15V10.5z" />
          </svg>
          {% trans "Print" %}
        </button>
      </div>
    </div>
  </div>

  <div class="mt-6">
    {% if next_url %}
    <a href="{{ next_url }}" class="btn btn-primary">
      {% trans "I've saved my codes - Continue" %}
    </a>
    {% else %}
    <a href="{% url 'core:two_factor_manage' %}" class="btn btn-primary">
      {% trans "I've saved my codes" %}
    </a>
    {% endif %}
  </div>
</div>

<script>
function copyBackupCodes() {
  const codes = [];
  document.querySelectorAll('#backup-codes > div').forEach(el => {
    codes.push(el.textContent.trim());
  });
  navigator.clipboard.writeText(codes.join('\n')).then(() => {
    alert('{% trans "Backup codes copied to clipboard!" %}');
  });
}

function printBackupCodes() {
  window.print();
}
</script>

<style>
@media print {
  .btn, .alert-warning, nav, footer, header {
    display: none !important;
  }
  #backup-codes {
    break-inside: avoid;
  }
}
</style>
{% endblock %}
