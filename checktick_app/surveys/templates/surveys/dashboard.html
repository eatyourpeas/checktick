{% extends 'base.html' %}
{% load i18n %}
{% load survey_extras %}
{% block head_theme_overrides %}
  {% if survey.style.theme_css_light or survey.style.theme_css_dark %}
  <style>
    {% if survey.style.theme_css_light %}
    [data-theme="checktick-light"] {
      {{ survey.style.theme_css_light|safe }}
    }
    {% endif %}
    {% if survey.style.theme_css_dark %}
    [data-theme="checktick-dark"] {
      {{ survey.style.theme_css_dark|safe }}
    }
    {% endif %}
  </style>
  {% endif %}
  {% if survey.style.font_css_url %}
    <link href="{{ survey.style.font_css_url }}" rel="stylesheet" />
  {% endif %}
{% endblock %}
{% block title %}{% trans "Dashboard" %} - {{ survey.name }}{% endblock %}
{% block content %}
<div role="alert" class="alert alert-info">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="h-6 w-6 shrink-0 stroke-current">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
  </svg>
  <span>{% trans "Keep track of survey status, number of responses and control styling." %}</span>
</div>
<div class="prose">
  {% trans "Surveys" as bc_surveys %}
  {% trans "Survey Dashboard" as bc_survey_dashboard %}
  {% include 'components/breadcrumbs.html' with crumb1_label=bc_surveys crumb1_href="/surveys/" crumb2_label=bc_survey_dashboard crumb2_href="/surveys/"|add:survey.slug|add:"/dashboard/" %}
</div>

{# Language switcher - button group above title #}
<div class="mb-4">
  <div class="join">
    {# Current language - active/selected with accent color #}
    <button class="btn join-item btn-accent btn-sm btn-active">
      <span class="text-base mr-1">{{ survey.language|default:'en'|language_flag }}</span>
      <span>{{ survey.language|language_name }}</span>
      <span class="ml-1 text-xs opacity-70">({% if survey.status == 'published' %}{% trans "Published" %}{% else %}{% trans "Draft" %}{% endif %})</span>
    </button>

    {# Other translations - clickable with primary color #}
    {% for trans in available_translations %}
      <a href="/surveys/{{ trans.slug }}/dashboard/"
         class="btn join-item btn-sm"
         title="{{ trans.language|language_name }} - {% if trans.status == 'published' %}{% trans 'Published' %}{% else %}{% trans 'Draft' %}{% endif %}">
        <span class="text-base mr-1">{{ trans.language|language_flag }}</span>
        <span>{{ trans.language|language_name }}</span>
        {% if trans.status == 'draft' %}
          <span class="ml-1 text-xs opacity-70">({% trans "Draft" %})</span>
        {% endif %}
      </a>
    {% endfor %}
  </div>
</div>

<div class="flex items-center gap-3 mt-2">
  <h2 class="text-2xl font-bold">
    <a class="link link-accent" href="/surveys/{{ survey.slug }}/groups/" id="survey-title-display">{{ survey.name }}</a>
  </h2>
  <button class="btn btn-ghost btn-sm btn-circle" id="edit-title-btn" title="{% trans 'Edit survey title' %}">
    {% include "components/icons/pencil.html" with classes="w-4 h-4" %}
  </button>
</div>

<div class="flex flex-wrap gap-2 items-center mb-2">
  <span class="badge badge-primary badge-outline">{% trans "Visibility" %}: {{ visible }}</span>
  <span class="badge badge-primary badge-outline">{% trans "Window" %}: {{ survey.start_at|default:'—' }} → {{ survey.end_at|default:'—' }}</span>
  <span class="badge badge-primary badge-outline">{% trans "Total responses" %}: {{ total }}{% if survey.max_responses %} / {{ survey.max_responses }}{% endif %}</span>
  {% if survey.visibility == 'token' %}
    <a class="badge badge-primary badge-outline hover:bg-primary hover:text-primary-content transition-colors cursor-pointer" href="{% url 'surveys:invites_pending' slug=survey.slug %}">{% trans "Invites" %}: {{ invites_sent }} / {{ total }}</a>
  {% endif %}
</div>

<div class="flex flex-wrap gap-2 mb-4">
  {% if survey.status == 'draft' %}
    <a class="btn btn-success btn-sm flex-shrink-0{% if survey.questions.count == 0 %} btn-disabled{% endif %}" href="{% if survey.questions.count > 0 %}{% url 'surveys:publish_settings' slug=survey.slug %}{% else %}#{% endif %}"{% if survey.questions.count == 0 %} aria-disabled="true" title="{% trans 'Add questions before publishing' %}"{% endif %}>
      {% include "components/icons/cloud-upload.html" with classes="w-5 h-5 mr-1" %}
      {% trans "Publish Survey" %}
    </a>
  {% elif survey.status == 'published' %}
    <a class="btn btn-primary btn-sm flex-shrink-0{% if survey.questions.count == 0 %} btn-disabled{% endif %}" href="{% if survey.questions.count > 0 %}{% url 'surveys:publish_settings' slug=survey.slug %}{% else %}#{% endif %}"{% if survey.questions.count == 0 %} aria-disabled="true" title="{% trans 'Add questions before publishing' %}"{% endif %}>
      {% include "components/icons/pencil.html" with classes="w-4 h-4 mr-1" %}
      {% trans "Edit Publication" %}
    </a>
  {% endif %}
  <a class="btn btn-primary btn-sm flex-shrink-0{% if survey.questions.count == 0 %} btn-disabled{% endif %}" href="{% if survey.questions.count > 0 %}/surveys/{{ survey.slug }}/preview/{% else %}#{% endif %}"{% if survey.questions.count == 0 %} aria-disabled="true" title="{% trans 'Add questions before previewing' %}"{% endif %}>{% trans "Survey Preview (read-only)" %}</a>

  {# Create Copy button - only show for original surveys #}
  {% if survey.is_original %}
  <a class="btn btn-outline btn-sm flex-shrink-0" href="{% url 'surveys:clone' slug=survey.slug %}" title="{% trans 'Create a copy of this survey' %}">
    {% include "components/icons/documents.html" with classes="w-4 h-4 mr-1" %}
    {% trans "Create Copy" %}
  </a>
  {% endif %}

  {# Create translation button - only show for original surveys #}
  {% if survey.is_original %}
    <button class="btn btn-outline btn-sm flex-shrink-0 create-translation-btn"
            data-survey-slug="{{ survey.slug }}"
            data-survey-id="{{ survey.id }}"
            data-existing-languages="{{ survey.language }}{% for trans in available_translations %},{{ trans.language }}{% endfor %}"
            title="{% trans 'Create a translation of this survey' %}">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
      </svg>
      {% trans "Create Translation" %}
    </button>
  {% endif %}

  {# Translate Again button - only show for translated surveys (not base language) #}
  {# Re-translates base survey content into current language without modal #}
  {% if survey.translated_from %}
    <button class="btn btn-outline btn-sm flex-shrink-0 retranslate-btn"
            data-survey-slug="{{ survey.translated_from.slug }}"
            data-survey-id="{{ survey.translated_from.id }}"
            data-target-language="{{ survey.language }}"
            title="{% trans 'Re-translate from base language if content has changed' %}">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
      </svg>
      {% trans "Translate Again" %}
    </button>
  {% endif %}

  {% if can_manage_users %}
  <a class="btn btn-primary btn-sm flex-shrink-0" href="/surveys/{{ survey.slug }}/users/">{% trans "Manage collaborators" %}</a>
  {% endif %}
  {% if survey.status == 'published' %}
    {% if survey.visibility == 'public' %}
      <button class="btn btn-outline btn-sm flex-shrink-0 copy-survey-link" data-slug="{{ survey.slug }}" data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ survey.slug }}/take/">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        {% trans "Copy Survey Link" %}
      </button>
    {% elif survey.visibility == 'unlisted' and survey.unlisted_key %}
      <button class="btn btn-outline btn-sm flex-shrink-0 copy-survey-link" data-slug="{{ survey.slug }}" data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ survey.slug }}/take/unlisted/{{ survey.unlisted_key }}/">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        {% trans "Copy Survey Link" %}
      </button>
    {% endif %}
  {% endif %}
</div>

<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
  <div class="stat bg-base-100 rounded-box shadow-sm">
    <div class="stat-title">{% trans "Today" %}</div>
    <div class="stat-value text-primary">{{ today_count }}</div>
    <div class="stat-desc">{% trans "Submissions" %}</div>
  </div>
  <div class="stat bg-base-100 rounded-box shadow-sm">
    <div class="stat-title">{% trans "Last 7 days" %}</div>
    <div class="stat-value text-primary">{{ last7_count }}</div>
    <div class="stat-desc">{% trans "Submissions" %}</div>
  </div>
  <div class="stat bg-base-100 rounded-box shadow-sm sm:col-span-2">
    <div class="stat-title">{% trans "Submission Trend" %}</div>
    <div class="stat-value text-primary">
      {% if survey.max_responses %}
        {{ total }}/{{ survey.max_responses }}
      {% else %}
        {{ total }}
      {% endif %}
    </div>
    <div class="stat-desc">
      {% if survey_not_started %}
        <div class="opacity-60">{% trans "Survey not yet started - no data available" %}</div>
      {% elif spark_points %}
        <svg viewBox="0 0 100 24" width="100%" height="24" preserveAspectRatio="none" aria-label="Submission trend chart">
          <polyline points="{{ spark_points }}" fill="none" stroke="currentColor" stroke-width="2" class="text-primary/80" />
          {% if invites_points %}
            <polyline points="{{ invites_points }}" fill="none" stroke="currentColor" stroke-width="1" class="text-secondary/60" stroke-dasharray="3,2" />
          {% endif %}
        </svg>
        <div class="text-xs opacity-70 mt-1 flex gap-3">
          <span><span class="inline-block w-3 h-0.5 bg-primary/80 align-middle"></span> {% trans "Responses" %}</span>
          {% if invites_points %}
            <span><span class="inline-block w-3 h-px bg-secondary/60 align-middle" style="border-top: 1px dashed currentColor;"></span> {% trans "Invites sent" %}</span>
          {% endif %}
        </div>
      {% else %}
        <div class="opacity-60">{% trans "No submissions yet" %}</div>
      {% endif %}
    </div>
  </div>
</div>

{% if survey.is_closed %}
<div class="mt-6 card bg-base-100 shadow-xl">
  <div class="card-body">
    <h2 class="card-title">
      {% trans "Data Governance" %}
      <a href="/docs/data-governance#data-export" class="btn btn-ghost btn-xs ml-auto" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        {% trans "Documentation" %}
      </a>
    </h2>

    <div class="alert alert-info mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <div class="text-sm">
        <p>{% blocktrans %}This survey is closed and data retention is active. See the {% endblocktrans %}<a href="/docs/data-governance#data-export" class="link" target="_blank">{% trans "data governance policy" %}</a>{% blocktrans %} for download procedures and retention guidelines.{% endblocktrans %}</p>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title">{% trans "Survey Status" %}</div>
        <div class="stat-value text-sm">{% trans "Closed" %}</div>
        <div class="stat-desc">{% trans "Closed on" %} {{ survey.closed_at|date:"Y-m-d H:i" }}</div>
      </div>

      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title">{% trans "Retention Period" %}</div>
        <div class="stat-value text-sm">{{ survey.retention_months }} {% trans "months" %}</div>
        {% if survey.deletion_date %}
        <div class="stat-desc">{% trans "Deletion scheduled" %}: {{ survey.deletion_date|date:"Y-m-d" }}</div>
        {% endif %}
      </div>
    </div>

    {% if can_export %}
    {% if total > 0 %}
    <div class="card-actions justify-end mt-4">
      <a href="{% url 'surveys:survey_export_create' survey.slug %}" class="btn btn-primary">
        {% include "components/icons/download.html" with classes="h-4 w-4 mr-1" %}
        {% trans "Download Survey Data" %}
      </a>
    </div>
    {% else %}
    <div class="mt-4">
      <div class="alert alert-warning mb-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span class="text-sm">{% trans "No responses to export yet. The download button will appear once responses are submitted." %}</span>
      </div>
      <div class="card-actions justify-end">
        <button class="btn btn-disabled" disabled>
          {% include "components/icons/download.html" with classes="h-4 w-4 mr-1" %}
          {% trans "Download Survey Data" %}
        </button>
      </div>
    </div>
    {% endif %}
    {% endif %}
  </div>
</div>
{% endif %}

{% if has_questions %}
<div class="alert alert-warning mt-6">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
  </svg>
  <div>
    <div class="font-semibold">{% trans "Edit your questions" %}</div>
    <div class="text-sm">{% trans "You can edit questions in" %} <strong>{{ survey.name }}</strong> {% trans "using the" %} <a href="{% url 'surveys:groups' slug=survey.slug %}" class="link link-primary font-semibold">{% trans "Question Builder" %}</a>, <a href="{% url 'surveys:bulk_upload' slug=survey.slug %}?tab=manual" class="link link-primary font-semibold">{% trans "Text Entry" %}</a>, {% trans "or the" %} <a href="{% url 'surveys:bulk_upload' slug=survey.slug %}?tab=ai" class="link link-primary font-semibold">{% trans "CheckTick AI Assistant" %}</a>.</div>
  </div>
</div>
{% else %}
<div class="alert alert-info mt-6">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
  <div>
    <div class="font-semibold">{% trans "Get started by adding questions" %}</div>
    <div class="text-sm">{% trans "You can add questions to" %} <strong>{{ survey.name }}</strong> {% trans "using the" %} <a href="{% url 'surveys:groups' slug=survey.slug %}" class="link link-primary font-semibold">{% trans "Question Builder" %}</a>, <a href="{% url 'surveys:bulk_upload' slug=survey.slug %}?tab=manual" class="link link-primary font-semibold">{% trans "Text Entry" %}</a>, {% trans "or the" %} <a href="{% url 'surveys:bulk_upload' slug=survey.slug %}?tab=ai" class="link link-primary font-semibold">{% trans "CheckTick AI Assistant" %}</a>.</div>
  </div>
</div>
{% endif %}

<div class="mt-6">
  <details class="mb-6">
  <summary class="cursor-pointer select-none text-lg font-semibold">{% trans "Survey style" %}</summary>
    <form class="mt-3 grid md:grid-cols-2 gap-3" method="post" action="/surveys/{{ survey.slug }}/style/update">
      {% csrf_token %}
      <div>
        <label class="label">Title override</label>
        <input class="input input-bordered w-full" name="title" value="{{ survey.style.title }}" placeholder="Defaults to platform title" />
      </div>
      <div>
        <label class="label">Icon URL</label>
        <input class="input input-bordered w-full" name="icon_url" value="{{ survey.style.icon_url }}" placeholder="/static/favicon.ico or absolute URL" />
      </div>
      <div>
        <label class="label">Theme name</label>
        <input class="input input-bordered w-full" name="theme_name" value="{{ survey.style.theme_name }}" placeholder="e.g. checktick, light, dark" />
      </div>
      <div>
        <label class="label">Primary color (hex)</label>
        <input class="input input-bordered w-full" name="primary_color" value="{{ survey.style.primary_color }}" placeholder="#fac8cd" />
        <p class="text-xs opacity-70 mt-1">Tip: paste a hex like #ff3366 — it will be converted to the correct OKLCH internally.</p>
      </div>
      <div>
        <label class="label">Heading font (CSS stack)</label>
        <input class="input input-bordered w-full" name="font_heading" value="{{ survey.style.font_heading }}" placeholder="'IBM Plex Sans', ui-sans-serif, ..." />
      </div>
      <div>
        <label class="label">Body font (CSS stack)</label>
        <input class="input input-bordered w-full" name="font_body" value="{{ survey.style.font_body }}" placeholder="Merriweather, ui-serif, ..." />
      </div>
      <div class="md:col-span-2">
        <label class="label">Font CSS URL (e.g. Google Fonts)</label>
        <input class="input input-bordered w-full" name="font_css_url" value="{{ survey.style.font_css_url }}" placeholder="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Source+Serif+4:wght@400;700&display=swap" />
      </div>
      <div class="md:col-span-2">
        <button class="btn btn-primary" type="submit">Save style</button>
      </div>
    </form>
  </details>

  {# Group management is available on the Groups page #}

  {# Danger zone - Delete survey #}
  <details class="collapse collapse-arrow bg-error/10 border border-error/30 mt-6">
    <summary class="collapse-title cursor-pointer select-none text-lg font-semibold text-error">
      {% trans "Danger Zone" %}
    </summary>
    <div class="mt-4 p-4">
      <div class="alert alert-error mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <div>
          <h3 class="font-bold">{% trans "Delete this survey" %}</h3>
          <p class="text-sm">{% trans "Once deleted, all data, responses, groups, and permissions will be permanently removed. This action cannot be undone." %}</p>
        </div>
      </div>
      <a href="{% url 'surveys:delete' survey.slug %}" class="btn btn-error">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
        {% trans "Delete Survey" %}
      </a>
    </div>
  </details>
</div>

<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  const copyButtons = document.querySelectorAll('.copy-survey-link');

  copyButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.dataset.url;
      const originalText = this.innerHTML;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => {
          // Show success feedback
          this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>{% trans "Copied!" %}';
          this.classList.add('btn-success');

          setTimeout(() => {
            this.innerHTML = originalText;
            this.classList.remove('btn-success');
          }, 2000);
        }).catch(() => {
          fallbackCopy(url, this, originalText);
        });
      } else {
        fallbackCopy(url, this, originalText);
      }
    });
  });

  function fallbackCopy(text, button, originalText) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();

    try {
      document.execCommand('copy');
      button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>{% trans "Copied!" %}';
      button.classList.add('btn-success');

      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
      }, 2000);
    } catch (err) {
      alert('{% trans "Failed to copy. Please copy manually:" %} ' + text);
    }

    document.body.removeChild(textarea);
  }

  // Edit title functionality
  const editTitleBtn = document.getElementById('edit-title-btn');
  const titleModal = document.getElementById('edit_title_modal');
  const cancelEditTitleBtn = document.getElementById('cancel_edit_title_btn');

  editTitleBtn.addEventListener('click', function() {
    const currentTitle = '{{ survey.name|escapejs }}';
    document.getElementById('survey_title_input').value = currentTitle;
    titleModal.showModal();
  });

  cancelEditTitleBtn.addEventListener('click', function() {
    titleModal.close();
  });

  document.getElementById('save_title_btn').addEventListener('click', function() {
    const newTitle = document.getElementById('survey_title_input').value.trim();

    if (!newTitle) {
      alert('{% trans "Please enter a title" %}');
      return;
    }

    // Save the title
    fetch('/surveys/{{ survey.slug }}/update-title/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ title: newTitle })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update the title in the page
        document.getElementById('survey-title-display').textContent = newTitle;
        document.title = '{% trans "Dashboard" %} - ' + newTitle;
        titleModal.close();
      } else {
        alert(data.error || '{% trans "Failed to update title" %}');
      }
    })
    .catch(error => {
      alert('{% trans "Error updating title" %}');
      console.error('Error:', error);
    });
  });

  // Translation functionality
  let currentSurveySlug = null;
  let currentSurveyId = null;
  let existingLanguages = [];

  const translation_modal = document.getElementById('translation_modal');
  const translation_progress_modal = document.getElementById('translation_progress_modal');
  const cancelTranslationBtn = document.getElementById('cancel_translation_btn');

  cancelTranslationBtn.addEventListener('click', function() {
    translation_modal.close();
  });

  // Create Translation button functionality
  const createTranslationButtons = document.querySelectorAll('.create-translation-btn');
  const languageSelect = document.getElementById('translation_language');
  const allLanguageOptions = Array.from(languageSelect.querySelectorAll('option[value]')).map(opt => ({
    value: opt.value,
    text: opt.textContent
  }));

  createTranslationButtons.forEach(button => {
    button.addEventListener('click', function() {
      currentSurveySlug = this.dataset.surveySlug;
      currentSurveyId = this.dataset.surveyId;
      existingLanguages = (this.dataset.existingLanguages || '').split(',').filter(l => l);

      // Filter language options
      languageSelect.innerHTML = '<option value="">{% trans "Select a language..." %}</option>';
      allLanguageOptions.forEach(opt => {
        if (!existingLanguages.includes(opt.value)) {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.text;
          languageSelect.appendChild(option);
        }
      });

      translation_modal.showModal();
    });
  });

  // Handle translation creation
  document.getElementById('create_translation_btn').addEventListener('click', function() {
    const targetLanguage = document.getElementById('translation_language').value;

    if (!targetLanguage) {
      alert('{% trans "Please select a target language" %}');
      return;
    }

    // Close the selection modal and show progress modal
    translation_modal.close();
    translation_progress_modal.showModal();

    // Send translation request
    fetch(`/surveys/${currentSurveySlug}/translations/create/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        survey_id: currentSurveyId,
        target_language: targetLanguage
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.task_id) {
        pollTranslationStatus(data.task_id, currentSurveySlug);
      } else if (data.error) {
        translation_progress_modal.close();
        alert(data.error);
      }
    })
    .catch(error => {
      translation_progress_modal.close();
      alert('{% trans "Failed to create translation. Please try again." %}');
      console.error('Translation error:', error);
    });
  });

  // Handle re-translation (Translate Again button)
  const retranslateButtons = document.querySelectorAll('.retranslate-btn');
  retranslateButtons.forEach(button => {
    button.addEventListener('click', function() {
      const surveySlug = this.dataset.surveySlug;
      const surveyId = this.dataset.surveyId;
      const targetLanguage = this.dataset.targetLanguage;

      if (!confirm('{% trans "This will re-translate the survey content from the base language. Any manual edits will be overwritten. Continue?" %}')) {
        return;
      }

      // Show progress modal
      translation_progress_modal.showModal();

      // Send translation request
      fetch(`/surveys/${surveySlug}/translations/create/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          survey_id: surveyId,
          target_language: targetLanguage,
          force_retranslate: true
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.task_id) {
          pollTranslationStatus(data.task_id, surveySlug);
        } else if (data.error) {
          translation_progress_modal.close();
          alert(data.error);
        }
      })
      .catch(error => {
        translation_progress_modal.close();
        alert('{% trans "Failed to re-translate. Please try again." %}');
        console.error('Re-translation error:', error);
      });
    });
  });

  function pollTranslationStatus(taskId, slug) {
    const interval = setInterval(() => {
      fetch(`/surveys/${slug}/translations/status/${taskId}/`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'completed') {
            clearInterval(interval);
            translation_progress_modal.close();
            location.reload(); // Reload to show updated data
          } else if (data.status === 'error') {
            clearInterval(interval);
            translation_progress_modal.close();
            alert('{% trans "Translation failed. Please try again or contact support." %}');
          }
          // Update status text if available
          if (data.message) {
            document.getElementById('translation_status_text').textContent = data.message;
          }
        })
        .catch(error => {
          clearInterval(interval);
          translation_progress_modal.close();
          console.error('Status polling error:', error);
        });
    }, 1000);
  }
});
</script>

<!-- Edit Title Modal -->
<dialog id="edit_title_modal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold">{% trans "Edit Survey Title" %}</h3>

    <div class="form-control w-full mt-4">
      <label class="label">
        <span class="label-text">{% trans "Survey Title" %}</span>
      </label>
      <input type="text" id="survey_title_input" class="input input-bordered w-full" maxlength="200" />
    </div>

    <div class="modal-action">
      <button id="cancel_edit_title_btn" class="btn">{% trans "Cancel" %}</button>
      <button id="save_title_btn" class="btn btn-primary">
        {% include "components/icons/pencil.html" with classes="w-4 h-4 mr-1" %}
        {% trans "Save" %}
      </button>
    </div>
  </div>
</dialog>

<!-- Translation Creation Modal -->
<dialog id="translation_modal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold">{% trans "Create Translation" %}</h3>
    <p class="py-4">{% trans "This will create a copy of the survey in the selected language. The content will be automatically translated using AI, but you should review all translations before publishing." %}</p>

    <div class="form-control w-full">
      <label class="label">
        <span class="label-text">{% trans "Target Language" %}</span>
      </label>
      <select id="translation_language" class="select select-bordered w-full">
        <option value="">{% trans "Select a language..." %}</option>
        {% for code, name in supported_languages %}
          <option value="{{ code }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="alert alert-warning mt-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span>{% trans "AI translation may not be perfect. Always review content before publishing." %}</span>
    </div>

    <div class="modal-action">
      <button id="cancel_translation_btn" class="btn">{% trans "Cancel" %}</button>
      <button id="create_translation_btn" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
        </svg>
        {% trans "Create Translation" %}
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>{% trans "close" %}</button>
  </form>
</dialog>

<!-- Translation Progress Modal -->
<dialog id="translation_progress_modal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold">{% trans "Creating Translation..." %}</h3>
    <div class="py-4">
      <progress class="progress progress-primary w-full"></progress>
      <p class="text-sm text-center mt-2" id="translation_status_text">{% trans "Translating survey content..." %}</p>
    </div>
  </div>
</dialog>

{% endblock %}
