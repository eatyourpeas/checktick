{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block title %}{% trans "Manage Questions" %} - {{ survey.name }} Â· {{ group.name }}{% endblock %}
{% block content %}
<div class="flex flex-col gap-6">
  <div class="prose">
  {% trans "Survey Dashboard" as crumb1_text %}
  {% trans "Question Groups" as crumb2_text %}
  {% trans "Manage Questions" as crumb3_text %}
  {% include 'components/breadcrumbs.html' with crumb1_label=crumb1_text crumb1_href="/surveys/"|add:survey.slug|add:"/dashboard/" crumb2_label=crumb2_text crumb2_href="/surveys/"|add:survey.slug|add:"/groups/" crumb3_label=crumb3_text %}
    <h1 class="inline-flex items-center gap-2 text-base-content">
      {% include "components/icons/documents.html" with classes="w-6 h-6 text-base-content" %}
      <span>{% trans "Manage Questions" %}</span>
    </h1>
    <h2 class="mt-0 text-base-content/80">{% trans "Question Group" %}: {{ group.name }}</h2>
    {% if group.description %}<p class="mt-0">{{ group.description }}</p>{% endif %}
  </div>

  <div class="grid md:grid-cols-3 gap-6">
    {% if group.schema.template == 'patient_details_encrypted' %}
      <div class="md:col-span-2">
        {% include 'surveys/partials/demographics_builder.html' %}
      </div>
      <!-- No Add Question sidebar for demographics group -->
    {% elif group.schema.template == 'professional_details' %}
      <div class="md:col-span-2">
        {% include 'surveys/partials/professional_builder.html' %}
      </div>
      <!-- No Add Question sidebar for professional details group -->
    {% else %}
      <div class="md:col-span-2">
        <div class="card bg-base-100 shadow">
          <div class="card-body">
            <h2 class="card-title inline-flex items-center gap-2 text-base-content">
              {% include "components/icons/documents.html" with classes="w-5 h-5 text-base-content" %}
              <span>{% trans "Questions in this group" %}</span>
            </h2>
            <div id="questions-list">
              <ul id="questions-draggable" class="flex flex-col gap-3 w-full" data-reorder-url="/surveys/{{ survey.slug }}/builder/groups/{{ group.id }}/questions/reorder">
                {% for q in questions %}
                  {% include 'surveys/partials/question_row.html' %}
                {% empty %}
                  <li class="p-4 opacity-70 bg-base-200 rounded-lg border border-dashed border-base-300 text-center">{% trans "No questions in this group yet." %}</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>



      <div>
        <div class="card bg-base-100 shadow builder-editor-card" data-builder-editor-card>
          <div class="card-body">
            <h2 class="card-title inline-flex items-center gap-2 text-base-content">
              {% include "components/icons/document.html" with classes="w-5 h-5 text-base-content" %}
              <span data-editor-label="headline-add">Add Question</span>
              <span data-editor-label="headline-edit" class="hidden">Edit Question</span>
            </h2>
            <p class="text-sm opacity-60 hidden" data-editor-label="edit-hint">Editing an existing question. Save to apply your changes or cancel to restore the original.</p>
            <form id="create-question-form" hx-post="/surveys/{{ survey.slug }}/builder/groups/{{ group.id }}/questions/create" hx-target="#questions-list" hx-swap="outerHTML" data-create-url="/surveys/{{ survey.slug }}/builder/groups/{{ group.id }}/questions/create" data-create-target="#questions-list" data-create-swap="outerHTML" data-edit-url-base="/surveys/{{ survey.slug }}/builder/groups/{{ group.id }}/questions/" data-template-url="/surveys/{{ survey.slug }}/builder/groups/{{ group.id }}/templates/add">
              {% csrf_token %}

              <div role="tablist" class="tabs tabs-lifted">
                <input type="radio" name="add_question_tabs" role="tab" class="tab" aria-label="Build question" checked/>
                <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                  <h3 class="text-lg font-semibold mb-4">Build a Question</h3>
                  <fieldset>
                    <legend class="label">Type</legend>
                    <div class="flex flex-wrap gap-3">
                      <label class="label cursor-pointer gap-2"><input type="radio" name="type" value="text" class="radio radio-primary" checked> <span>Text/Number</span></label>
                      <label class="label cursor-pointer gap-2"><input type="radio" name="type" value="mc_single" class="radio radio-primary"> <span>Multiple Choice (single)</span></label>
                      <label class="label cursor-pointer gap-2"><input type="radio" name="type" value="mc_multi" class="radio radio-primary"> <span>Multiple Choice (multi)</span></label>
                      <label class="label cursor-pointer gap-2"><input type="radio" name="type" value="dropdown" class="radio radio-primary"> <span>Dropdown</span></label>
                      <label class="label cursor-pointer gap-2"><input type="radio" name="type" value="orderable" class="radio radio-primary"> <span>Orderable</span></label>
                      <label class="label cursor-pointer gap-2"><input type="radio" name="type" value="yesno" class="radio radio-primary"> <span>Yes/No</span></label>
                      <label class="label cursor-pointer gap-2"><input type="radio" name="type" value="likert" class="radio radio-primary"> <span>Likert scale</span></label>
                      <label class="label cursor-pointer gap-2"><input type="radio" name="type" value="image" class="radio radio-primary"> <span>Image choice</span></label>
                    </div>
                  </fieldset>

                  <label class="label mt-2">Question text</label>
                  <input name="text" class="input input-bordered w-full" required />

                  <div data-section="text-options" class="mt-3">
                    <fieldset>
                      <legend class="label">Answer format</legend>
                      <div class="flex gap-3">
                        <label class="label cursor-pointer gap-2"><input type="radio" name="text_format" value="free" class="radio radio-primary" checked> <span>Free text</span></label>
                        <label class="label cursor-pointer gap-2"><input type="radio" name="text_format" value="number" class="radio radio-primary"> <span>Number</span></label>
                      </div>
                    </fieldset>
                  </div>

                  <div data-section="options" class="mt-3 hidden">
                    <div class="mb-3" data-prefilled-container>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="checkbox checkbox-sm" id="use-prefilled-options" data-prefilled-toggle />
                        <span class="label-text">Use prefilled options</span>
                      </label>
                    </div>
                    <div id="prefilled-dataset-section" class="mb-3 hidden" data-prefilled-section>
                      <label class="label">Select dataset</label>
                      <select name="prefilled_dataset" id="prefilled-dataset-select" class="select select-bordered w-full" data-prefilled-dataset>
                        <option value="">-- Choose a dataset --</option>
                        {% for key, name in available_datasets.items %}
                        <option value="{{ key }}">{{ name }}</option>
                        {% endfor %}
                      </select>
                      <button type="button" class="btn btn-sm btn-primary mt-2" data-load-dataset>Load options</button>
                    </div>
                    <label class="label">Options (one per line)</label>
                    <textarea name="options" class="textarea textarea-bordered w-full" placeholder="Option A
Option B" data-options-textarea></textarea>
                    <div class="mt-3" data-options-followup-container>
                      <div class="flex items-center justify-between mb-2">
                        <label class="label mb-0">Follow-up text inputs</label>
                        <button type="button" class="btn btn-xs btn-ghost" data-refresh-followup-options>Refresh from options above</button>
                      </div>
                      <p class="text-xs opacity-60 mb-2">Enable follow-up text inputs for specific answers (e.g., "If Other, please elaborate")</p>
                      <div id="followup-options-list" class="space-y-2" data-followup-options-list>
                        <!-- Dynamically populated based on options -->
                      </div>
                    </div>
                  </div>

                  <div data-section="likert" class="mt-3 hidden">
                    <fieldset>
                      <legend class="label">Likert mode</legend>
                      <div class="flex gap-3">
                        <label class="label cursor-pointer gap-2"><input type="radio" name="likert_mode" value="categories" class="radio radio-primary" checked> <span>Categories</span></label>
                        <label class="label cursor-pointer gap-2"><input type="radio" name="likert_mode" value="number" class="radio radio-primary"> <span>Number scale</span></label>
                      </div>
                    </fieldset>
                    <div data-likert="categories" class="mt-3">
                      <label class="label">Categories (one per line)</label>
                      <textarea name="likert_categories" class="textarea textarea-bordered w-full" placeholder="Strongly disagree
                          Disagree
                          Neutral
                          Agree
                          Strongly agree"></textarea>
                    </div>
                    <div data-likert="number" class="mt-3 hidden">
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="label">Min value</label>
                          <input type="number" name="likert_min" class="input input-bordered w-full" value="1" />
                        </div>
                        <div>
                          <label class="label">Max value</label>
                          <input type="number" name="likert_max" class="input input-bordered w-full" value="5" />
                        </div>
                      </div>
                      <div class="grid grid-cols-2 gap-3 mt-3">
                        <div>
                          <label class="label">Left label</label>
                          <input type="text" name="likert_left_label" class="input input-bordered w-full" placeholder="Low" />
                        </div>
                        <div>
                          <label class="label">Right label</label>
                          <input type="text" name="likert_right_label" class="input input-bordered w-full" placeholder="High" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <div data-section="yesno-followup" class="mt-3 hidden">
                    <label class="label">Follow-up text inputs</label>
                    <p class="text-xs opacity-60 mb-2">Enable follow-up text inputs for Yes or No answers</p>
                    <div class="space-y-3">
                      <div class="flex items-start gap-3 p-3 bg-base-200 rounded-lg">
                        <input type="checkbox" class="checkbox mt-1" name="yesno_yes_followup" id="yesno-yes-followup" />
                        <div class="flex-1">
                          <label for="yesno-yes-followup" class="font-medium cursor-pointer">Enable follow-up for "Yes"</label>
                          <input type="text" name="yesno_yes_followup_label" class="input input-sm input-bordered w-full mt-2" placeholder="Please elaborate..." />
                        </div>
                      </div>
                      <div class="flex items-start gap-3 p-3 bg-base-200 rounded-lg">
                        <input type="checkbox" class="checkbox mt-1" name="yesno_no_followup" id="yesno-no-followup" />
                        <div class="flex-1">
                          <label for="yesno-no-followup" class="font-medium cursor-pointer">Enable follow-up for "No"</label>
                          <input type="text" name="yesno_no_followup_label" class="input input-sm input-bordered w-full mt-2" placeholder="Please elaborate..." />
                        </div>
                      </div>
                    </div>
                  </div>

                  <div data-section="image-options" class="mt-3 hidden">
                    <div role="alert" class="alert alert-warning mb-4">
                      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                      <div>
                        <h3 class="font-bold">{% trans "Images are not encrypted" %}</h3>
                        <div class="text-sm">{% trans "Only use for non-medical, non-patient-identifying images. Do not upload images that could identify patients." %}</div>
                      </div>
                    </div>

                    <p class="text-sm opacity-60 mb-3">
                      {% trans "Upload images for respondents to choose from. Each image becomes a selectable option. Save the question first, then add images." %}
                    </p>

                    <div id="image-upload-container" class="hidden" data-image-upload-container>
                      <label class="label">{% trans "Images" %}</label>
                      <div id="image-list" class="flex flex-wrap gap-2 mb-3" data-image-list>
                        <!-- Images will be dynamically populated here -->
                      </div>

                      <div class="flex items-center gap-2">
                        <input type="file" id="image-upload-input" accept="image/png,image/jpeg,image/webp,image/svg+xml" class="file-input file-input-bordered file-input-sm w-full max-w-xs" data-image-upload-input />
                        <input type="text" id="image-label-input" class="input input-bordered input-sm flex-1" placeholder="{% trans 'Optional label' %}" data-image-label-input />
                        <button type="button" class="btn btn-sm btn-primary" data-upload-image-btn>{% trans "Upload" %}</button>
                      </div>
                      <p class="text-xs opacity-60 mt-1">{% trans "Max 1MB per image. Allowed: PNG, JPG, WebP, SVG. Images larger than 800x800 will be resized." %}</p>
                    </div>

                    <div id="image-upload-placeholder" data-image-upload-placeholder>
                      <p class="text-sm text-warning">{% trans "Save this question first to enable image uploads." %}</p>
                    </div>
                  </div>
                </div>

                {% if can_edit %}
                <input type="radio" name="add_question_tabs" role="tab" class="tab" aria-label="Special Templates" />
                <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                  <h3 class="text-lg font-semibold mb-4">Special Templates</h3>
                  <div class="space-y-4">
                    <p class="text-sm opacity-60 leading-snug">
                      Templates are predefined sets of questions for common use cases. They can form part of question groups or be used on their own.
                    </p>
                    <fieldset>
                      <legend class="label">Template type</legend>
                      <div class="space-y-3">
                        {% if can_collect_patient_data %}
                        <label class="flex items-start gap-3 cursor-pointer">
                          <input type="radio" name="template" value="patient_details_encrypted" class="radio radio-primary mt-1" />
                          <div class="space-y-1">
                            <span class="font-semibold">Patient details (encrypted)</span>
                            <p class="text-sm opacity-60 leading-snug max-w-prose">
                              Customisable set of patient identifier questions, with answers stored encrypted, viewable only to the person that entered the data.
                            </p>
                          </div>
                        </label>
                        {% else %}
                        <div class="flex items-start gap-3 opacity-50 cursor-not-allowed">
                          <input type="radio" name="template" value="patient_details_encrypted" class="radio radio-primary mt-1" disabled />
                          <div class="space-y-1">
                            <span class="font-semibold">Patient details (encrypted)</span>
                            <span class="badge badge-warning badge-sm ml-2">{% trans "Paid feature" %}</span>
                            <p class="text-sm opacity-60 leading-snug max-w-prose">
                              Customisable set of patient identifier questions, with answers stored encrypted, viewable only to the person that entered the data.
                            </p>
                            <p class="text-sm text-warning leading-snug">
                              <a href="{% url 'core:pricing' %}" class="link link-warning">{% trans "Upgrade to Pro" %}</a> {% trans "to collect encrypted patient data." %}
                            </p>
                          </div>
                        </div>
                        {% endif %}
                        <label class="flex items-start gap-3 cursor-pointer">
                          <input type="radio" name="template" value="professional_details" class="radio radio-primary mt-1" />
                          <div class="space-y-1">
                            <span class="font-semibold">Professional details</span>
                            <p class="text-sm opacity-60 leading-snug max-w-prose">
                              Customisable set of professional identifier questions. Answers are stored in clear (non-encrypted) and can be exported.
                            </p>
                          </div>
                        </label>
                      </div>
                    </fieldset>

                    <div role="alert" class="alert alert-info mt-6">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <div>
                        <h4 class="font-bold">Need a different custom template?</h4>
                        <div class="text-sm">
                          If you need a specialized question format not listed here (like the Patient/Professional templates),
                          <a href="https://github.com/eatyourpeas/checktick/issues/new?template=custom_template_request.yml" target="_blank" class="link link-primary">request a custom template on GitHub</a>.
                          Note: Custom templates are different from Question Group Templates (reusable questionnaires like PHQ-9).
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>

              <div class="mt-4">
                <label class="label">Required</label>
                <input type="checkbox" name="required" class="toggle toggle-primary" />
              </div>

              <div class="mt-4 flex items-center gap-3">
                <button class="btn btn-primary" type="submit">
                  <span data-editor-label="submit-add">Add</span>
                  <span data-editor-label="submit-edit" class="hidden">Save changes</span>
                </button>
                <button type="button" class="btn btn-ghost hidden" data-action="cancel-edit">Cancel</button>
              </div>
            </form>


          </div>
        </div>
      </div>

    {% endif %}
  </div>
</div>

<script src="{% static 'js/sortable.min.js' %}"
        integrity="sha384-x9T5uN6arBCGAt3RJPa+A5l/6KQXb0UC7Eig1DxZI+EekZYlD+5S+EEJ+U2lebod"
        crossorigin="anonymous"></script>
<script src="{% static 'js/builder.js' %}?v={{ build.commit|default:build.timestamp }}">
</script>
{% endblock %}
