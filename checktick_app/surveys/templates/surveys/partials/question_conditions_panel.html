{% with payload=q.builder_payload %}
  {% if payload.condition_options %}
    {% with opts=payload.condition_options %}
      <details class="mt-4 border border-base-300 rounded-lg bg-base-100/70 px-4 py-3" data-condition-panel>
        <summary class="flex cursor-pointer items-center justify-between gap-2 text-sm font-semibold">
          <span>Conditional logic</span>
          {% if payload.conditions %}
            <span class="badge badge-sm badge-outline">{{ payload.conditions|length }} active</span>
          {% else %}
            <span class="badge badge-sm">Off</span>
          {% endif %}
        </summary>
        <div class="mt-4 space-y-5">
          {% if not opts.can_create %}
            <div class="alert alert-info text-sm">
              <span>No available target questions or groups yet. Add another question or group to enable conditional branching.</span>
            </div>
          {% else %}
            <div class="space-y-3 rounded-lg border border-dashed border-base-300 bg-base-200/40 p-3">
              <h4 class="text-sm font-medium">Add a condition</h4>
              <form method="post" hx-post="/surveys/{{ q.survey.slug }}/builder/questions/{{ q.id }}/conditions/create" hx-target="closest li[data-qid]" hx-swap="outerHTML" data-condition-form data-condition-mode="create">
                {% csrf_token %}
                {% if group %}
                  <input type="hidden" name="context_group_id" value="{{ group.id }}" />
                {% endif %}
                <label class="label text-xs">Description <span class="opacity-60">(optional)</span></label>
                <input type="text" name="description" class="input input-bordered w-full" placeholder="e.g. Participant answered yes" />

                <label class="label text-xs mt-3">Operator</label>
                <select name="operator" class="select select-bordered w-full" data-condition-operator>
                  {% for operator in opts.operators %}
                    <option value="{{ operator.value }}" data-requires-value="{{ operator.requires_value|yesno:'1,0' }}">{{ operator.label }}</option>
                  {% endfor %}
                </select>

                <div class="mt-2" data-condition-value>
                  <label class="label text-xs">Comparison value</label>
                  <input type="text" name="value" class="input input-bordered w-full" placeholder="Comparison value" />
                </div>

                <label class="label text-xs mt-3">Action</label>
                <select name="action" class="select select-bordered w-full condition-action-select" data-condition-action>
                  {% for action in opts.actions %}
                    <option value="{{ action.value }}">{{ action.label }}</option>
                  {% endfor %}
                </select>

                <!-- Dynamic help text that changes based on selected action -->
                <div class="action-help alert alert-info text-xs mt-2 p-3">
                  <div data-action="show" class="hidden">
                    <strong>▶ Show:</strong> The target question will be <strong>hidden by default</strong>
                    and only appear when this condition is true.
                    <br><em class="text-gray-600">Use for: "Show follow-up question when..."</em>
                  </div>
                  <div data-action="jump_to" class="hidden">
                    <strong>⏩ Skip ahead:</strong> When condition is true, skip all questions between
                    this one and the target.
                    <br><em class="text-gray-600">Use for: "If answered No, jump to end"</em>
                  </div>
                  <div data-action="skip" class="hidden">
                    <strong>✕ Hide:</strong> When condition is true, the target question will be hidden.
                    <br><em class="text-gray-600">Use for: "Don't show Q5 if Q3 = Yes"</em>
                  </div>
                  <div data-action="end_survey" class="hidden">
                    <strong>■ End survey:</strong> Stop the survey immediately when condition is true.
                    <br><em class="text-gray-600">Use for: "End survey if not applicable"</em>
                  </div>
                </div>

                <div class="mt-3" data-target-fieldset>
                  <label class="label text-xs">Target question</label>
                  <select name="target_question" class="select select-bordered w-full" data-target-select="question" data-condition-target>
                    {% if not opts.has_question_targets %}
                      <option value="">No available questions</option>
                    {% else %}
                      {% for tq in opts.target_questions %}
                        <option value="{{ tq.id }}"{% if tq.id == opts.default_question_id %} selected{% endif %}>{{ tq.label }}</option>
                      {% endfor %}
                    {% endif %}
                  </select>
                  <div class="text-xs text-gray-500 mt-1">
                    Note: END_SURVEY action does not require a target question
                  </div>
                </div>

                <!-- Live preview showing what the condition will do -->
                <div class="bg-base-200 p-3 rounded mt-3 condition-preview">
                  <strong class="text-xs">This condition will:</strong>
                  <p class="text-sm mt-1 condition-preview-text"></p>
                </div>

                <div class="mt-3 flex justify-end">
                  <button type="submit" class="btn btn-primary btn-sm">Add condition</button>
                </div>
              </form>
            </div>
          {% endif %}

          <div>
            <h4 class="text-sm font-medium">Existing conditions</h4>
            {% if payload.conditions %}
              <ul class="mt-2 space-y-3" data-condition-list>
                {% for cond in payload.conditions %}
                  <li class="space-y-2 rounded-lg border border-base-300 bg-base-100/70 p-3" data-condition-id="{{ cond.id }}">
                    <div class="flex flex-col gap-1 sm:flex-row sm:items-start sm:justify-between">
                      <div>
                        <p class="text-sm font-medium">{{ cond.description|default:cond.summary }}</p>
                        <p class="text-xs opacity-70">{{ cond.summary }}</p>
                      </div>
                      <span class="badge badge-sm badge-outline self-start sm:self-center">Order {{ cond.order }}</span>
                    </div>
                    <details class="mt-2" data-condition-editor>
                      <summary class="link link-primary text-sm">Edit condition</summary>
                      <div class="mt-2 space-y-3">
                        <form method="post" hx-post="/surveys/{{ q.survey.slug }}/builder/questions/{{ q.id }}/conditions/{{ cond.id }}/update" hx-target="closest li[data-qid]" hx-swap="outerHTML" data-condition-form data-condition-mode="edit">
                          {% csrf_token %}
                          {% if group %}
                            <input type="hidden" name="context_group_id" value="{{ group.id }}" />
                          {% endif %}
                          <label class="label text-xs">Description</label>
                          <input type="text" name="description" class="input input-bordered w-full" value="{{ cond.description }}" />

                          <label class="label text-xs mt-3">Operator</label>
                          <select name="operator" class="select select-bordered w-full" data-condition-operator>
                            {% for operator in opts.operators %}
                              <option value="{{ operator.value }}" data-requires-value="{{ operator.requires_value|yesno:'1,0' }}"{% if operator.value == cond.operator %} selected{% endif %}>{{ operator.label }}</option>
                            {% endfor %}
                          </select>

                          <div class="mt-2{% if not cond.requires_value %} hidden{% endif %}" data-condition-value>
                            <label class="label text-xs">Comparison value</label>
                            <input type="text" name="value" class="input input-bordered w-full" value="{{ cond.value }}" {% if not cond.requires_value %}disabled{% endif %} />
                          </div>

                          <label class="label text-xs mt-3">Action</label>
                          <select name="action" class="select select-bordered w-full condition-action-select" data-condition-action>
                            {% for action in opts.actions %}
                              <option value="{{ action.value }}"{% if action.value == cond.action %} selected{% endif %}>{{ action.label }}</option>
                            {% endfor %}
                          </select>

                          <!-- Dynamic help text that changes based on selected action -->
                          <div class="action-help alert alert-info text-xs mt-2 p-3">
                            <div data-action="show" class="hidden">
                              <strong>▶ Show:</strong> The target question will be <strong>hidden by default</strong>
                              and only appear when this condition is true.
                              <br><em class="text-gray-600">Use for: "Show follow-up question when..."</em>
                            </div>
                            <div data-action="jump_to" class="hidden">
                              <strong>⏩ Skip ahead:</strong> When condition is true, skip all questions between
                              this one and the target.
                              <br><em class="text-gray-600">Use for: "If answered No, jump to end"</em>
                            </div>
                            <div data-action="skip" class="hidden">
                              <strong>✕ Hide:</strong> When condition is true, the target question will be hidden.
                              <br><em class="text-gray-600">Use for: "Don't show Q5 if Q3 = Yes"</em>
                            </div>
                            <div data-action="end_survey" class="hidden">
                              <strong>■ End survey:</strong> Stop the survey immediately when condition is true.
                              <br><em class="text-gray-600">Use for: "End survey if not applicable"</em>
                            </div>
                          </div>

                          <div class="mt-3" data-target-fieldset>
                            <label class="label text-xs">Target question</label>
                            <select name="target_question" class="select select-bordered w-full" data-target-select="question" data-condition-target>
                              {% if not opts.has_question_targets %}
                                <option value="">No available questions</option>
                              {% else %}
                                {% for tq in opts.target_questions %}
                                  <option value="{{ tq.id }}"{% if cond.target_question_id == tq.id %} selected{% endif %}>{{ tq.label }}</option>
                                {% endfor %}
                              {% endif %}
                            </select>
                            <div class="text-xs text-gray-500 mt-1">
                              Note: END_SURVEY action does not require a target question
                            </div>
                          </div>

                          <!-- Live preview showing what the condition will do -->
                          <div class="bg-base-200 p-3 rounded mt-3 condition-preview">
                            <strong class="text-xs">This condition will:</strong>
                            <p class="text-sm mt-1 condition-preview-text"></p>
                          </div>

                          <div class="mt-2">
                            <label class="label text-xs whitespace-nowrap">Evaluation order</label>
                            <input type="number" name="order" class="input input-bordered w-full" value="{{ cond.order }}" min="0" />
                            <div class="text-xs text-gray-500 mt-1">
                              When multiple conditions exist, lower numbers are evaluated first
                            </div>
                          </div>

                          <div class="mt-3 flex justify-end gap-2">
                            <button type="submit" class="btn btn-primary btn-xs">Save changes</button>
                          </div>
                        </form>
                        <form method="post" hx-post="/surveys/{{ q.survey.slug }}/builder/questions/{{ q.id }}/conditions/{{ cond.id }}/delete" hx-target="closest li[data-qid]" hx-swap="outerHTML" hx-confirm="Delete this condition?" class="flex justify-end">
                          {% csrf_token %}
                          {% if group %}
                            <input type="hidden" name="context_group_id" value="{{ group.id }}" />
                          {% endif %}
                          <button type="submit" class="btn btn-warning btn-xs">Delete</button>
                        </form>
                      </div>
                    </details>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-sm opacity-70">No conditions yet.</p>
            {% endif %}
          </div>
        </div>
      </details>
    {% endwith %}
  {% endif %}
{% endwith %}

<script>
// Show contextual help for selected action and update preview
function setupConditionForm(form) {
  const actionSelect = form.querySelector('[data-condition-action]');
  const operatorSelect = form.querySelector('[data-condition-operator]');
  const valueInput = form.querySelector('[name="value"]');
  const targetSelect = form.querySelector('[data-condition-target]');
  const helpContainer = form.querySelector('.action-help');
  const previewText = form.querySelector('.condition-preview-text');

  if (!actionSelect || !helpContainer) return;

  function updateHelp() {
    const selectedAction = actionSelect.value;
    helpContainer.querySelectorAll('[data-action]').forEach(el => {
      el.classList.add('hidden');
    });
    const helpDiv = helpContainer.querySelector('[data-action="' + selectedAction + '"]');
    if (helpDiv) {
      helpDiv.classList.remove('hidden');
    }
  }

  function updatePreview() {
    if (!previewText) return;

    const operatorText = operatorSelect?.selectedOptions[0]?.text || '';
    const value = valueInput?.value || '';
    const action = actionSelect.value;
    const targetText = targetSelect?.selectedOptions[0]?.text || '';

    let preview = '';
    if (action === 'show') {
      preview = 'Hide "' + targetText + '" by default. Only show it when this question ' + operatorText.toLowerCase() + (value ? ' "' + value + '"' : '');
    } else if (action === 'jump_to') {
      preview = 'When this question ' + operatorText.toLowerCase() + (value ? ' "' + value + '"' : '') + ', skip ahead to "' + targetText + '"';
    } else if (action === 'skip') {
      preview = 'When this question ' + operatorText.toLowerCase() + (value ? ' "' + value + '"' : '') + ', hide "' + targetText + '"';
    } else if (action === 'end_survey') {
      preview = 'When this question ' + operatorText.toLowerCase() + (value ? ' "' + value + '"' : '') + ', end the survey';
    }

    previewText.textContent = preview;
  }

  actionSelect.addEventListener('change', function() {
    updateHelp();
    updatePreview();
  });

  // Update preview on any field change
  if (operatorSelect) operatorSelect.addEventListener('change', updatePreview);
  if (valueInput) valueInput.addEventListener('input', updatePreview);
  if (targetSelect) targetSelect.addEventListener('change', updatePreview);

  // Show initial state
  updateHelp();
  updatePreview();
}

// Setup all condition forms on page load
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('[data-condition-form]').forEach(setupConditionForm);
});

// Setup newly added forms (after HTMX updates)
document.body.addEventListener('htmx:afterSettle', function(event) {
  event.detail.elt.querySelectorAll('[data-condition-form]').forEach(setupConditionForm);
});
</script>
