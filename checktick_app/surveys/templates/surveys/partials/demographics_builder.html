{% load i18n %}
{% if show_patient_details %}
<div id="demographics-preview" class="card bg-base-100 shadow mt-4">
  <div class="card-body">
    <h3 class="card-title">{% trans "Patient Demographics (encrypted)" %}</h3>
    <p class="text-sm opacity-70">{% trans "These fields are encrypted at rest and never exported with identifiers." %}</p>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
      {% for key,label in demographic_defs.items %}
        {% if key in demographics_fields %}
          {% if key == 'nhs_number' %}
          <label class="input input-bordered input-sm flex items-center gap-1.5">
            <input type="text" name="nhs_number" class="grow min-w-0 bg-transparent outline-none border-0" placeholder="{{ label }}" hx-post="{% url 'surveys:validate_nhs_number' %}" hx-trigger="blur, keyup changed delay:500ms" hx-target="closest label" hx-swap="outerHTML" />
            <svg class="w-4 h-4 opacity-50 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <g stroke-linejoin="round" stroke-linecap="round" stroke-width="2.5" fill="none" stroke="currentColor">
                <path d="M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z"></path>
                <circle cx="16.5" cy="7.5" r=".5" fill="currentColor"></circle>
              </g>
            </svg>
          </label>
          {% elif key == 'post_code' %}
          <label class="input input-bordered input-sm flex items-center gap-1.5">
            <input type="text" name="post_code" class="grow min-w-0 bg-transparent outline-none border-0" placeholder="{{ label }}" hx-post="{% url 'surveys:validate_postcode' %}" hx-trigger="blur, keyup changed delay:500ms" hx-target="closest label" hx-swap="outerHTML" />
            <svg class="w-4 h-4 opacity-50 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <g stroke-linejoin="round" stroke-linecap="round" stroke-width="2.5" fill="none" stroke="currentColor">
                <path d="M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z"></path>
                <circle cx="16.5" cy="7.5" r=".5" fill="currentColor"></circle>
              </g>
            </svg>
          </label>
          {% else %}
          <label class="input input-bordered input-sm flex items-center gap-1.5">
            <input class="grow min-w-0 bg-transparent outline-none border-0" name="{{ key }}" placeholder="{{ label }}" />
            <svg class="w-4 h-4 opacity-50 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <g stroke-linejoin="round" stroke-linecap="round" stroke-width="2.5" fill="none" stroke="currentColor">
                <path d="M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z"></path>
                <circle cx="16.5" cy="7.5" r=".5" fill="currentColor"></circle>
              </g>
            </svg>
          </label>
          {% endif %}
        {% endif %}
      {% endfor %}
        {% if 'post_code' in demographics_fields and include_imd %}
          <label class="input input-bordered input-sm flex items-center gap-1.5">
            <input class="grow min-w-0 bg-transparent outline-none border-0" placeholder="Index of Multiple Deprivation" disabled />
            <svg class="w-4 h-4 opacity-50 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <g stroke-linejoin="round" stroke-linecap="round" stroke-width="2.5" fill="none" stroke="currentColor">
                <path d="M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z"></path>
                <circle cx="16.5" cy="7.5" r=".5" fill="currentColor"></circle>
              </g>
            </svg>
          </label>
        {% endif %}
    </div>
    <form class="mt-4" hx-post="/surveys/{{ survey.slug }}/builder/demographics/update" hx-target="#demographics-preview" hx-swap="outerHTML" hx-trigger="change">
      {% csrf_token %}
      <fieldset>
        <legend class="label">Include these fields</legend>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
          {% for key,label in demographic_defs.items %}
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" class="checkbox" name="fields" value="{{ key }}" {% if key in demographics_fields %}checked{% endif %} />
              <span class="label-text">{{ label }}</span>
            </label>
          {% endfor %}
        </div>
      </fieldset>
        {% if 'post_code' in demographics_fields %}
        <fieldset class="mt-3">
          <legend class="label">Postcode-derived</legend>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" class="checkbox" name="include_imd" {% if include_imd %}checked{% endif %} />
            <span class="label-text">Include IMD (adds read-only field “Index of Multiple Deprivation”)</span>
          </label>
        </fieldset>
        {% endif %}

    </form>
  </div>
</div>
{% endif %}
