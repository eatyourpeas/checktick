{% load i18n %}
{% with s=item.survey %}
<li class="w-full">
  <div class="w-full bg-base-100 rounded-lg border border-base-300 p-3 sm:p-4 hover:border-primary transition-colors">
    <div class="flex items-center gap-4 min-w-0">
      <div class="flex-shrink-0 inline-flex items-center justify-center">
        {% include "components/icons/checktick.html" with classes=brand.icon_size_class|default:'w-8 h-8' aria_label=brand.icon_alt|default:brand.title title=brand.icon_title|default:brand.title %}
      </div>
      <div class="min-w-0 w-full">
        <div class="flex items-center gap-2 min-w-0 flex-wrap">
          <a href="/surveys/{{ s.slug }}/dashboard/" class="font-medium leading-tight truncate link link-accent">{{ s.name }}</a>

          {# Role badge - show user's access level #}
          {% if item.role == 'owner' %}
            <span class="badge badge-accent badge-sm" title="{% trans 'You created this survey' %}">{% trans "Owner" %}</span>
          {% elif item.role == 'admin' %}
            <span class="badge badge-secondary badge-sm" title="{% trans 'You can manage this survey and its users' %}">{% trans "Admin" %}</span>
          {% elif item.role == 'creator' %}
            <span class="badge badge-info badge-sm" title="{% trans 'You can edit and manage this survey' %}">{% trans "Creator" %}</span>
          {% elif item.role == 'editor' %}
            <span class="badge badge-info badge-sm" title="{% trans 'You can edit this survey' %}">{% trans "Editor" %}</span>
          {% elif item.role == 'viewer' %}
            <span class="badge badge-ghost badge-sm" title="{% trans 'You can view this survey' %}">{% trans "Viewer" %}</span>
          {% endif %}

          {# Status badge with language flags #}
          {% if s.status == 'published' %}
            <span class="badge badge-primary badge-outline whitespace-nowrap flex items-center gap-1">
              <span>{% trans "Published" %}</span>
              <span class="text-base" title="{{ item.language_name }}">{{ item.flag }}</span>
              {% for trans in item.translations %}
                {% if trans.status == 'published' %}
                  <span class="text-base" title="{{ trans.language_name }}">{{ trans.flag }}</span>
                {% endif %}
              {% endfor %}
            </span>
          {% else %}
            <span class="badge badge-primary badge-outline whitespace-nowrap flex items-center gap-1">
              <span>{% trans "Draft" %}</span>
              <span class="text-base" title="{{ item.language_name }}">{{ item.flag }}</span>
              {% for trans in item.translations %}
                {% if trans.status == 'draft' %}
                  <span class="text-base" title="{{ trans.language_name }}">{{ trans.flag }}</span>
                {% endif %}
              {% endfor %}
            </span>
          {% endif %}

          {# Draft translations badge #}
          {% if s.status == 'published' %}
            {% regroup item.translations by status as translations_by_status %}
            {% for status_group in translations_by_status %}
              {% if status_group.grouper == 'draft' %}
                <span class="badge badge-warning badge-outline whitespace-nowrap flex items-center gap-1">
                  <span>{% trans "Draft translations" %}</span>
                  {% for trans in status_group.list %}
                    <span class="text-base" title="{{ trans.language_name }}">{{ trans.flag }}</span>
                  {% endfor %}
                </span>
              {% endif %}
            {% endfor %}
          {% endif %}

          {# Days remaining badge #}
          {% if s.status == 'published' %}
            {% with days=s.days_remaining %}
              {% if days is None %}
                <span class="badge badge-info badge-outline whitespace-nowrap">{% trans "No end date" %}</span>
              {% elif days < 0 %}
                <span class="badge badge-error badge-outline whitespace-nowrap">{% trans "Expired" %}</span>
              {% elif days == 0 %}
                <span class="badge badge-warning badge-outline whitespace-nowrap">{% trans "Ends today" %}</span>
              {% elif days == 1 %}
                <span class="badge badge-warning badge-outline whitespace-nowrap">{% trans "1 day remaining" %}</span>
              {% elif days <= 7 %}
                <span class="badge badge-warning badge-outline whitespace-nowrap">{{ days }} {% trans "days remaining" %}</span>
              {% else %}
                <span class="badge badge-success badge-outline whitespace-nowrap">{{ days }} {% trans "days remaining" %}</span>
              {% endif %}
            {% endwith %}
          {% endif %}
        </div>
        {% if s.description %}
          <div class="text-sm opacity-70 truncate">{{ s.description }}</div>
        {% endif %}
      </div>
    </div>

    {# Action buttons - conditional based on role #}
    <div class="-mx-1 overflow-x-auto mt-3">
      <div class="px-1 min-w-max flex items-center gap-2">
        {# Dashboard - always visible #}
        <a class="btn btn-secondary btn-sm" href="/surveys/{{ s.slug }}/dashboard/">
          {% include "components/icons/clipboard.html" with classes="w-4 h-4 mr-1" %}
          {% trans "Dashboard" %}
        </a>

        {# Clone/Copy - only for editors and above #}
        {% if item.can_edit %}
          <a class="btn btn-outline btn-sm" href="{% url 'surveys:clone' slug=s.slug %}" title="{% trans 'Create a copy of this survey' %}">
            {% include "components/icons/documents.html" with classes="w-4 h-4 mr-1" %}
            {% trans "Create Copy" %}
          </a>
        {% endif %}

        {# Create Translation - only for editors and above with questions #}
        {% if item.can_edit %}
          {% if s.questions.count > 0 %}
            <button class="btn btn-outline btn-sm create-translation-btn"
                    data-survey-slug="{{ s.slug }}"
                    data-survey-id="{{ s.id }}"
                    data-existing-languages="{{ s.language }}{% for trans in item.translations %},{{ trans.survey.language }}{% endfor %}"
                    title="{% trans 'Create a translation of this survey' %}">
              {% include "components/icons/language.html" with classes="w-4 h-4 mr-1" %}
              {% trans "Create Translation" %}
            </button>
          {% else %}
            <button class="btn btn-outline btn-sm btn-disabled" aria-disabled="true" title="{% trans 'Add questions before creating translation' %}">
              {% include "components/icons/language.html" with classes="w-4 h-4 mr-1" %}
              {% trans "Create Translation" %}
            </button>
          {% endif %}
        {% endif %}

        {# Preview - always visible if has questions #}
        <a class="btn btn-secondary btn-sm{% if s.questions.count == 0 %} btn-disabled{% endif %}" href="{% if s.questions.count > 0 %}/surveys/{{ s.slug }}/preview/{% else %}#{% endif %}"{% if s.questions.count == 0 %} aria-disabled="true" title="{% trans 'Add questions before previewing' %}"{% endif %}>
          {% include "components/icons/building.html" with classes="w-4 h-4 mr-1" %}
          {% trans "Preview" %}
        </a>

        {# Publish/Edit Publication - only for editors and above #}
        {% if item.can_edit %}
          {% if s.status == 'draft' %}
            <a class="btn btn-success btn-sm{% if s.questions.count == 0 %} btn-disabled{% endif %}" href="{% if s.questions.count > 0 %}{% url 'surveys:publish_settings' slug=s.slug %}{% else %}#{% endif %}"{% if s.questions.count == 0 %} aria-disabled="true" title="{% trans 'Add questions before publishing' %}"{% endif %}>
              {% include "components/icons/cloud-upload.html" with classes="w-4 h-4 mr-1" %}
              {% trans "Publish" %}
            </a>
          {% elif s.status == 'published' %}
            <a class="btn btn-primary btn-sm{% if s.questions.count == 0 %} btn-disabled{% endif %}" href="{% if s.questions.count > 0 %}{% url 'surveys:publish_settings' slug=s.slug %}{% else %}#{% endif %}"{% if s.questions.count == 0 %} aria-disabled="true" title="{% trans 'Add questions before publishing' %}"{% endif %}>
              {% include "components/icons/pencil.html" with classes="w-4 h-4 mr-1" %}
              {% trans "Edit Publication" %}
            </a>
          {% endif %}
        {% endif %}

        {# Copy Link - visible for published surveys #}
        {% if s.status == 'published' %}
          {% if s.visibility == 'public' %}
            <button class="btn btn-outline btn-sm copy-survey-link" data-slug="{{ s.slug }}" data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ s.slug }}/take/">
              {% include "components/icons/documents.html" with classes="w-4 h-4 mr-1" %}
              {% trans "Copy Link" %}
            </button>
          {% elif s.visibility == 'unlisted' and s.unlisted_key %}
            <button class="btn btn-outline btn-sm copy-survey-link" data-slug="{{ s.slug }}" data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ s.slug }}/take/unlisted/{{ s.unlisted_key }}/">
              {% include "components/icons/documents.html" with classes="w-4 h-4 mr-1" %}
              {% trans "Copy Link" %}
            </button>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</li>
{% endwith %}
