{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Survey Invitations" %} - {{ survey.name }}{% endblock %}
{% block content %}
<div class="prose">
  {% trans "Surveys" as bc_surveys %}
  {% trans "Survey Dashboard" as bc_survey_dashboard %}
  {% trans "Invitations" as bc_invitations %}
  {% include 'components/breadcrumbs.html' with crumb1_label=bc_surveys crumb1_href="/surveys/" crumb2_label=bc_survey_dashboard crumb2_href="/surveys/"|add:survey.slug|add:"/dashboard/" crumb3_label=bc_invitations %}
  <h2>{{ survey.name }} — {% trans "Invitations" %}</h2>
</div>

<div class="mt-4">
  <div class="flex flex-wrap gap-2 mb-4">
    <span class="badge badge-lg badge-outline">{% trans "Total" %}: {{ invites|length }}</span>
    <span class="badge badge-lg badge-success">{% trans "Completed" %}: {{ completed_count }}</span>
    <span class="badge badge-lg badge-warning">{% trans "Pending" %}: {{ pending_count }}</span>
  </div>

  <p class="mb-3 opacity-70">{% blocktrans %}The list below shows all invited email addresses and their completion status.{% endblocktrans %}</p>
  {% if invites %}
    <div class="overflow-x-auto">
      <table class="table w-full">
        <thead>
          <tr>
            <th>{% trans "Status" %}</th>
            <th>{% trans "Invited at" %}</th>
            <th>{% trans "Email" %}</th>
            <th>{% trans "QR" %}</th>
            <th>{% trans "Completed at" %}</th>
            <th>{% trans "Actions" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for item in invites %}
          <tr class="{% if item.is_completed %}opacity-60{% endif %}">
            <td>
              {% if item.is_completed %}
                <span class="badge badge-success badge-sm">{% trans "Completed" %}</span>
              {% else %}
                <span class="badge badge-warning badge-sm">{% trans "Pending" %}</span>
              {% endif %}
            </td>
            <td>{{ item.token.created_at|date:"d M Y H:i" }}</td>
            <td>{{ item.email }}</td>
            <td>
              {% if not item.is_completed %}
              <button class="btn btn-ghost btn-xs show-invite-qr"
                      data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ survey.slug }}/take/"
                      data-email="{{ item.email }}"
                      title="{% trans 'Show QR Code' %}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                </svg>
              </button>
              {% else %}
              <span class="opacity-50">—</span>
              {% endif %}
            </td>
            <td>
              {% if item.completed_at %}
                {{ item.completed_at|date:"d M Y H:i" }}
              {% else %}
                <span class="opacity-50">—</span>
              {% endif %}
            </td>
            <td>
              {% if not item.is_completed %}
              <form method="post" action="{% url 'surveys:invite_resend' slug=survey.slug token_id=item.token.id %}" class="inline" onsubmit="return confirm('{% trans "Resend invitation to" %} {{ item.email }}?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-xs btn-outline btn-primary">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  {% trans "Resend" %}
                </button>
              </form>
              {% else %}
              <span class="opacity-50 text-sm">{% trans "No action needed" %}</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      <span>{% trans "No invitations have been sent yet. You can send invitations from the publication settings page." %}</span>
    </div>
  {% endif %}

  <p class="mt-4"><a class="btn btn-primary hover:bg-primary-focus transition-colors" href="{% url 'surveys:dashboard' slug=survey.slug %}">{% trans "Back to dashboard" %}</a></p>
</div>

<!-- QR Code Modal for Authenticated Invites -->
<dialog id="invite_qr_modal" class="modal">
  <div class="modal-box text-center">
    <h3 class="text-lg font-bold mb-4">{% trans "Survey QR Code" %}</h3>
    <img id="invite_qr_image" src="" alt="{% trans 'QR Code' %}" class="mx-auto mb-4" width="200" height="200" />
    <p id="invite_qr_url" class="text-sm text-base-content/70 break-all mb-2"></p>
    <p id="invite_qr_email" class="text-xs text-base-content/50 mb-4"></p>
    <div class="alert alert-info text-sm mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      <span>{% trans "The user will need to log in with this email address to complete the survey." %}</span>
    </div>
    <div class="modal-action justify-center gap-2">
      <button id="download_invite_qr_btn" class="btn btn-primary btn-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        {% trans "Download" %}
      </button>
      <form method="dialog">
        <button class="btn btn-sm">{% trans "Close" %}</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>{% trans "close" %}</button>
  </form>
</dialog>

<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  const qrButtons = document.querySelectorAll('.show-invite-qr');
  const qrModal = document.getElementById('invite_qr_modal');
  const qrImage = document.getElementById('invite_qr_image');
  const qrUrl = document.getElementById('invite_qr_url');
  const qrEmail = document.getElementById('invite_qr_email');
  const downloadBtn = document.getElementById('download_invite_qr_btn');

  qrButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.dataset.url;
      const email = this.dataset.email;
      qrUrl.textContent = url;
      qrEmail.textContent = '{% trans "For:" %} ' + email;

      // Fetch QR code from server
      fetch('{% url "surveys:get_qr_code" slug=survey.slug %}?url=' + encodeURIComponent(url))
        .then(response => response.json())
        .then(data => {
          if (data.qr_code) {
            qrImage.src = data.qr_code;
            downloadBtn.onclick = function() {
              const link = document.createElement('a');
              // Sanitize email for filename
              const safeEmail = email.replace(/[^a-zA-Z0-9]/g, '-');
              link.download = '{{ survey.slug }}-invite-' + safeEmail + '-qr.png';
              link.href = data.qr_code;
              link.click();
            };
            qrModal.showModal();
          }
        })
        .catch(error => {
          console.error('Error fetching QR code:', error);
        });
    });
  });
});
</script>
{% endblock %}
