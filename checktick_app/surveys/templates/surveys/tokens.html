{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Invite Tokens" %} - {{ survey.name }}{% endblock %}
{% block content %}
<div class="prose max-w-3xl">
  <h2 class="flex items-center gap-3">
    <span>{% trans "Invite tokens" %}</span>
    <a class="link link-primary text-sm" href="{% url 'core:docs_page' slug='publish-and-collection' %}">{% trans "Learn more" %}</a>
  </h2>
  <form method="post" class="grid md:grid-cols-3 gap-3">
    {% csrf_token %}
    <div>
      <label class="label">{% trans "How many" %}</label>
      <input name="count" type="number" min="1" max="1000" class="input input-bordered w-full" placeholder="100" />
    </div>
    <div>
      <label class="label">{% trans "Expires at (ISO)" %}</label>
      <input name="expires_at" type="datetime-local" class="input input-bordered w-full" />
    </div>
    <div>
      <label class="label">{% trans "Note" %}</label>
      <input name="note" class="input input-bordered w-full" placeholder="Batch note" />
    </div>
    <div class="md:col-span-3">
      <button class="btn btn-primary" type="submit">{% trans "Generate" %}</button>
      <a class="btn btn-ghost" href="/surveys/{{ survey.slug }}/tokens/export.csv">{% trans "Export CSV" %}</a>
    </div>
  </form>
  <table class="table w-full mt-6">
    <thead>
      <tr>
        <th>{% trans "Token" %}</th>
        <th>{% trans "QR" %}</th>
        <th>{% trans "Created" %}</th>
        <th>{% trans "Expires" %}</th>
        <th>{% trans "Used" %}</th>
        <th>{% trans "Used by" %}</th>
        <th>{% trans "Note" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for t in tokens %}
      <tr>
        <td class="font-mono text-xs">{{ t.token }}</td>
        <td>
          <button class="btn btn-ghost btn-xs show-token-qr"
                  data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ survey.slug }}/take/token/{{ t.token }}/"
                  data-token="{{ t.token }}"
                  title="{% trans 'Show QR Code' %}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
            </svg>
          </button>
        </td>
        <td>{{ t.created_at }}</td>
        <td>{{ t.expires_at }}</td>
        <td>{{ t.used_at }}</td>
        <td>{{ t.used_by_id }}</td>
        <td>{{ t.note }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="7" class="opacity-70">{% trans "No tokens yet." %}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- QR Code Modal -->
<dialog id="token_qr_modal" class="modal">
  <div class="modal-box text-center">
    <h3 class="text-lg font-bold mb-4">{% trans "Token QR Code" %}</h3>
    <img id="token_qr_image" src="" alt="{% trans 'QR Code' %}" class="mx-auto mb-4" width="200" height="200" />
    <p id="token_qr_url" class="text-sm text-base-content/70 break-all mb-2"></p>
    <p id="token_qr_token" class="text-xs font-mono text-base-content/50 mb-4"></p>
    <div class="modal-action justify-center gap-2">
      <button id="download_token_qr_btn" class="btn btn-primary btn-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        {% trans "Download" %}
      </button>
      <form method="dialog">
        <button class="btn btn-sm">{% trans "Close" %}</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>{% trans "close" %}</button>
  </form>
</dialog>

<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  const qrButtons = document.querySelectorAll('.show-token-qr');
  const qrModal = document.getElementById('token_qr_modal');
  const qrImage = document.getElementById('token_qr_image');
  const qrUrl = document.getElementById('token_qr_url');
  const qrToken = document.getElementById('token_qr_token');
  const downloadBtn = document.getElementById('download_token_qr_btn');

  qrButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.dataset.url;
      const token = this.dataset.token;
      qrUrl.textContent = url;
      qrToken.textContent = 'Token: ' + token;

      // Fetch QR code from server
      fetch('{% url "surveys:get_qr_code" slug=survey.slug %}?url=' + encodeURIComponent(url))
        .then(response => response.json())
        .then(data => {
          if (data.qr_code) {
            qrImage.src = data.qr_code;
            downloadBtn.onclick = function() {
              const link = document.createElement('a');
              link.download = '{{ survey.slug }}-token-' + token + '-qr.png';
              link.href = data.qr_code;
              link.click();
            };
            qrModal.showModal();
          }
        })
        .catch(error => {
          console.error('Error fetching QR code:', error);
        });
    });
  });
});
</script>
{% endblock %}
