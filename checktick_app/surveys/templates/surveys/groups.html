{% extends 'base.html' %}
{% load i18n static survey_extras %}
{% block head_theme_overrides %}
  {% if survey.style.theme_css_light or survey.style.theme_css_dark %}
    <style></style>
  {% endif %}
  {% if survey.style.font_css_url %}
    <link href="{{ survey.style.font_css_url }}" rel="stylesheet" />
  {% endif %}
{% endblock %}
{% block title %}
  {% trans 'Groups' %}- {{ survey.name }}
{% endblock %}
{% block content %}
  <div class="prose max-w-none">
    {% trans 'Surveys' as crumb1_text %}
    {% trans 'Survey Dashboard' as crumb2_text %}
    {% trans 'Question Groups' as crumb3_text %}
    {% include 'components/breadcrumbs.html' with crumb1_label=crumb1_text crumb1_href='/surveys/' crumb2_label=crumb2_text crumb2_href='/surveys/'|add:survey.slug|add:'/dashboard/' crumb3_label=crumb3_text %}
    <h1 class="inline-flex items-center gap-2 w-full text-base-content">
      {% include "components/icons/checktick_question_group.html" with classes="w-7 h-7" %}
      <span>{% blocktrans %}Question Groups for {{ survey }}{% endblocktrans %}</span>
    </h1>
    <p class="mt-2 text-sm opacity-80 w-full">
      {% blocktrans %}Question Groups are reusable sets of questions. Drag to reorder them—this controls the order participants see each section. Need to ask the same questions multiple times? Select groups and click "Create repeat" to let participants add entries (e.g., details for each family member or each hospital visit).{% endblocktrans %}
    </p>
  </div>

  <div class="mt-4">
    <div class="space-y-3">
      <div class="alert shadow-sm bg-base-100 border-l-4 border-primary">
        <div>
          {% include 'components/icons/repeat.html' with classes='w-5 h-5 text-primary' %}
        </div>
        <div class="text-sm text-base-content">
          {% trans 'Tip: Select groups by clicking their row or checkbox, then click ‘Create repeat’ to set a name. Selected rows are highlighted and show a small repeat icon.' %}
        </div>
      </div>
      <ul id="groups-draggable" class="orderable-list w-full flex flex-col gap-3" aria-label="Reorder groups" data-reorder-url="/surveys/{{ survey.slug }}/groups/reorder" data-can-edit="{{ can_edit|yesno:'true,false' }}">
        {% for g in groups %}
          {% with info=repeat_info|get_item:g.id %}
            <li class="w-full" data-gid="{{ g.id }}" data-repeat="{{ info.is_repeated|default_if_none:False|yesno:'1,0' }}" title="{{ info.tooltip }}">
              <div class="w-full bg-base-100 rounded-lg border border-base-300 p-3 selectable-group hover:border-primary cursor-pointer transition-colors {% if info.is_repeated %}ring-1 ring-primary/40 bg-primary/5{% endif %}">
                <!-- Main row: controls + name -->
                <div class="flex items-center gap-2 sm:gap-3">
                  {% if can_edit %}
                    <button type="button" class="drag-handle inline-flex items-center justify-center w-7 h-7 rounded-md text-primary border border-primary/30 hover:bg-primary/20 shrink-0 cursor-move" style="background-color: color-mix(in oklch, var(--p) 12%, transparent);" aria-label="Drag to reorder" title="Drag to reorder">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48" fill="currentColor" aria-hidden="true" focusable="false">
                        <path d="M14 20h20v-4H14v4Zm0 6h20v-4H14v4Zm0 6h20v-4H14v4Z" />
                      </svg>
                    </button>
                    <input type="checkbox" class="checkbox checkbox-sm select-checkbox" aria-label="Select group" />
                  {% endif %}
                  <div class="q-number badge badge-primary badge-sm shrink-0">{{ forloop.counter }}</div>
                  <div class="flex-1 min-w-0">
                    <a class="font-medium link underline hover:text-primary truncate block" href="/surveys/{{ survey.slug }}/builder/groups/{{ g.id }}/">{{ g.name }}</a>
                    {% if g.description %}
                      <div class="text-sm text-base-content/70 truncate hidden sm:block">{{ g.description }}</div>
                    {% endif %}
                  </div>
                  <span class="sel-repeat-icon hidden tooltip" data-tip="{% trans 'Selected for repeat' %}">{% include 'components/icons/repeat.html' with classes='w-4 h-4 opacity-70' %}</span>

                  <!-- Badges: always visible -->
                  {% if info.is_repeated %}
                    <div class="tooltip" data-tip="{{ info.tooltip }}">
                      {% if can_edit %}
                        <button type="button" class="edit-repeat-btn badge badge-info shrink-0 self-center inline-flex items-center gap-1 cursor-pointer hover:badge-primary transition-colors"
                                data-collection-id="{{ info.collection_id }}"
                                data-collection-name="{{ info.collection_name }}"
                                data-min-count="{{ info.min_count }}"
                                data-max-count="{{ info.max_count|default:'' }}"
                                title="{% trans 'Click to edit repeat settings' %}">
                          {% include 'components/icons/repeat.html' with classes='w-4 h-4' %}
                          <span class="hidden sm:inline">{% trans 'Repeats' %}</span>
                        </button>
                      {% else %}
                        <div class="badge badge-info shrink-0 self-center inline-flex items-center gap-1">
                          {% include 'components/icons/repeat.html' with classes='w-4 h-4' %}
                          <span class="hidden sm:inline">{% trans 'Repeats' %}</span>
                        </div>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="badge badge-neutral shrink-0 self-center text-xs">
                      <span class="sm:hidden">{{ g.q_count|default:0 }}</span>
                      <span class="hidden sm:inline">{% blocktrans count counter=g.q_count|default:0 %}{{ counter }} question{% plural %}{{ counter }} questions{% endblocktrans %}</span>
                    </div>
                  {% endif %}
                </div>

                <!-- Action buttons: horizontal scrollable row like survey list -->
                {% if can_edit %}
                  <div class="-mx-1 overflow-x-auto mt-3">
                    <div class="px-1 min-w-max flex items-center gap-2">
                      {% if not g.imported_from %}
                        <a href="{% url 'surveys:question_group_publish' slug=survey.slug gid=g.id %}" class="btn btn-xs btn-outline" title="{% trans 'Publish as template' %}">
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                          </svg>
                          <span class="hidden sm:inline">{% trans 'Publish' %}</span>
                        </a>
                      {% endif %}
                      <form method="post" action="/surveys/{{ survey.slug }}/groups/{{ g.id }}/delete" onsubmit="return confirm('{% trans 'Delete this group?' %}');" class="shrink-0 ml-auto">
                        {% csrf_token %}
                        <button class="btn btn-xs btn-warning" type="submit">{% trans 'Delete' %}</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </li>
          {% endwith %}
        {% empty %}
          <li class="opacity-70">
            {% trans 'No groups yet. Create one to get started.' %}
          </li>
        {% endfor %}
      </ul>
      <div class="flex flex-wrap gap-2 items-center sticky top-0 z-40 bg-base-200/95 backdrop-blur supports-[backdrop-filter]:bg-base-200/70 py-2">
        {% if can_edit %}
          <button id="create-repeat-btn" class="btn btn-secondary btn-sm inline-flex items-center gap-2" type="button" disabled>
            {% include 'components/icons/repeat.html' with classes='w-4 h-4' %}
            <span>{% trans 'Create repeat from selection' %}</span>
          </button>
          <form id="remove-repeat-form" method="post" action="/surveys/{{ survey.slug }}/groups/repeat/remove" class="inline" onsubmit="return confirm('{% trans 'Remove selected groups from their repeats?' %}');">
            {% csrf_token %}
            <input type="hidden" name="group_ids" id="remove-repeat-group-ids" />
            <button id="remove-repeat-btn" class="btn btn-ghost btn-sm inline-flex items-center gap-2" type="submit" disabled>
              {% include 'components/icons/repeat.html' with classes='w-4 h-4' %}
              <span>{% trans 'Remove from repeat' %}</span>
            </button>
          </form>
          <span id="selection-toolbar" class="text-sm opacity-80 hidden">
            <span id="selection-count">0</span> {% trans 'selected' %}
            <button type="button" id="clear-selection" class="btn btn-ghost btn-xs ml-2">{% trans 'Clear' %}</button>
          </span>
        {% endif %}
        <a class="btn btn-ghost btn-sm" href="/surveys/{{ survey.slug }}/dashboard/">{% trans 'Back to dashboard' %}</a>
        <a class="btn btn-ghost btn-sm" href="/docs/groups-view/" target="_blank" rel="noopener noreferrer">{% trans 'Help' %}</a>
        <a class="btn btn-sm btn-outline" href="{% url 'surveys:published_templates_list' %}">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          {% trans 'Browse & Import Templates' %}
        </a>
      </div>

      <!-- Add new question group form -->
      {% if can_edit %}
        <div class="mt-4">
          <form method="post" action="/surveys/{{ survey.slug }}/groups/create" class="inline-flex">
            {% csrf_token %}
            <div class="join">
              <input id="create-group-name" class="input input-bordered join-item" name="name" placeholder="{% trans 'New group name' %}" required />
              <button id="create-group-submit" class="btn join-item btn-primary" type="submit" disabled>{% trans 'Create new question group' %}</button>
            </div>
          </form>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Survey Map Visualizer -->
  <div class="mt-6">
    {% include 'surveys/partials/branching_visualizer.html' with survey=survey %}
  </div>

  {% if can_edit %}
    <dialog id="repeat-modal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">{% trans 'Create repeat' %}</h3>
        <form method="post" action="/surveys/{{ survey.slug }}/groups/repeat/create" id="repeat-form">
          {% csrf_token %}
          <input type="hidden" name="group_ids" id="repeat-group-ids" />
          <div class="mt-2">
            <label class="label">{% trans 'Repeat name' %}</label>
            <input class="input input-bordered w-full" name="name" required />
          </div>
          <div class="mt-2 grid grid-cols-2 gap-3">
            <div>
              <label class="label">{% trans 'Minimum items' %}</label>
              <input class="input input-bordered w-full" name="min_count" type="number" min="0" value="0" />
            </div>
            <div>
              <label class="label">{% trans 'Maximum items' %}</label>
              <select class="select select-bordered w-full" name="max_count">
                <option value="">
                  {% trans 'Unlimited' %}
                </option>
                {% int_range 1 10 as nums %}
                {% for n in nums %}
                  <option value="{{ n }}">{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          {% if existing_repeats %}
            <div class="mt-2">
              <label class="label">{% trans 'Nest under existing (optional)' %}</label>
              <select class="select select-bordered w-full" name="parent_id">
                <option value="">—</option>
                {% for c in existing_repeats %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
              <p class="text-xs opacity-70 mt-1">
                {% trans 'Nesting is limited to one level.' %}
              </p>
            </div>
          {% endif %}
          <div class="modal-action">
            <button class="btn" type="button" id="repeat-cancel-btn">{% trans 'Cancel' %}</button>
            <button class="btn btn-primary" type="submit">{% trans 'Create' %}</button>
          </div>
        </form>
      </div>
    </dialog>

    <!-- Edit Repeat Modal -->
    <dialog id="edit-repeat-modal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">{% trans 'Edit repeat' %}</h3>
        <form method="post" action="/surveys/{{ survey.slug }}/groups/repeat/edit" id="edit-repeat-form">
          {% csrf_token %}
          <input type="hidden" name="collection_id" id="edit-repeat-collection-id" />
          <div class="mt-2">
            <label class="label">{% trans 'Repeat name' %}</label>
            <input class="input input-bordered w-full" name="name" id="edit-repeat-name" required />
          </div>
          <div class="mt-2 grid grid-cols-2 gap-3">
            <div>
              <label class="label">{% trans 'Minimum items' %}</label>
              <input class="input input-bordered w-full" name="min_count" id="edit-repeat-min" type="number" min="0" value="0" />
            </div>
            <div>
              <label class="label">{% trans 'Maximum items' %}</label>
              <select class="select select-bordered w-full" name="max_count" id="edit-repeat-max">
                <option value="">{% trans 'Unlimited' %}</option>
                {% int_range 1 10 as nums %}
                {% for n in nums %}
                  <option value="{{ n }}">{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="modal-action">
            <button class="btn" type="button" id="edit-repeat-cancel-btn">{% trans 'Cancel' %}</button>
            <button class="btn btn-primary" type="submit">{% trans 'Save' %}</button>
          </div>
        </form>
      </div>
    </dialog>
  {% endif %}
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/sortable.min.js' %}" integrity="sha384-HZZ/fukV+9G8gwTNjN7zQDG0Sp7MsZy5DDN6VfY3Be7V9dvQpEpR2jF2HlyFUUjU" crossorigin="anonymous"></script>
  <script src="{% static 'js/groups.js' %}?v={{ build.commit|default:build.timestamp }}"></script>
  <script src="{% static 'js/groups-page.js' %}?v={{ build.commit|default:build.timestamp }}"></script>
{% endblock %}
