{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block title %}{{ dataset.name }} - {% trans "Datasets" %} - CheckTick{% endblock %}
{% block content %}
<div class="prose max-w-none">
  {% include 'components/breadcrumbs.html' with crumb1_label='Surveys' crumb1_href='/surveys/' crumb2_label='Datasets' crumb2_href='/surveys/datasets/' crumb3_label=dataset.name %}

  <div class="flex items-start justify-between">
    <div>
      <h1 class="inline-flex items-center gap-2">
        {{ dataset.name }}
        {% if dataset.category == 'nhs_dd' and not dataset.is_custom %}
          <span class="badge badge-info">{% trans "NHS DD" %}</span>
        {% endif %}
        {% if dataset.is_global %}
          <span class="badge badge-success">{% trans "Global" %}</span>
        {% endif %}
        <span class="badge badge-ghost text-sm">v{{ dataset.version }}</span>
      </h1>
      <p class="text-sm text-gray-600 mt-0">
        <code>{{ dataset.key }}</code>
      </p>
    </div>
    <div class="flex gap-2 not-prose">
      {% if can_edit %}
        <a href="{% url 'surveys:dataset_edit' dataset_id=dataset.id %}" class="btn btn-secondary btn-sm">
          {% trans "Edit" %}
        </a>
        <form method="post" action="{% url 'surveys:dataset_delete' dataset_id=dataset.id %}" onsubmit="return confirm('{% trans "Are you sure you want to delete this dataset?" %}');">
          {% csrf_token %}
          <button type="submit" class="btn btn-error btn-sm">
            {% trans "Delete" %}
          </button>
        </form>
      {% endif %}
      <a href="{% url 'surveys:dataset_create' %}?clone_from={{ dataset.id }}" class="btn btn-accent btn-sm">
        {% trans "Create Custom Version" %}
      </a>
    </div>
  </div>

  {% if dataset.description %}
    <div class="alert">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      <span>{{ dataset.description }}</span>
    </div>
  {% endif %}

  {% if dataset.tags %}
    <div class="not-prose my-4">
      <div class="flex flex-wrap gap-2 items-center">
        <span class="text-sm font-semibold text-gray-600">{% trans "Tags:" %}</span>
        {% for tag in dataset.tags %}
          <span class="badge badge-primary badge-lg">{{ tag }}</span>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="not-prose grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
    <div class="stats shadow">
      <div class="stat">
        <div class="stat-title">{% trans "Category" %}</div>
        <div class="stat-value text-2xl">{{ dataset.get_category_display }}</div>
        <div class="stat-desc">{{ dataset.get_source_type_display }}</div>
      </div>
    </div>

    <div class="stats shadow">
      <div class="stat">
        <div class="stat-title">{% trans "Organisation" %}</div>
        <div class="stat-value text-2xl">
          {% if dataset.organization %}
            {{ dataset.organization.name }}
          {% else %}
            <span class="text-gray-400">{% trans "Global" %}</span>
          {% endif %}
        </div>
        {% if dataset.created_by %}
          <div class="stat-desc">{% trans "Created by" %} {{ dataset.created_by.username }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  {% if dataset.parent %}
    <div class="alert alert-info">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      <span>
        {% trans "This is a custom version based on" %} <strong>{{ dataset.parent.name }}</strong>
      </span>
    </div>
  {% endif %}

  <h2>{% trans "Options" %} ({{ dataset.options|length }})</h2>

  {% if dataset.format_pattern %}
    <p class="text-sm text-gray-600">
      <strong>{% trans "Format:" %}</strong> <code>{{ dataset.format_pattern }}</code>
    </p>
  {% endif %}

  <div class="not-prose">
    {# All datasets now use dictionary format with keys and values #}
    <div class="grid grid-cols-2 gap-4">
      <div class="overflow-x-auto max-h-96 border rounded-lg">
        <div class="bg-base-300 px-4 py-2 font-semibold text-sm border-b">{% trans "Keys" %}</div>
        <ul class="menu bg-base-200 text-sm">
          {% for key, value in dataset.options.items %}
            <li><a class="cursor-default hover:bg-base-200">
              <code class="text-xs font-semibold text-primary">{{ key }}</code>
            </a></li>
          {% endfor %}
        </ul>
      </div>
      <div class="overflow-x-auto max-h-96 border rounded-lg">
        <div class="bg-base-300 px-4 py-2 font-semibold text-sm border-b">{% trans "Values" %}</div>
        <ul class="menu bg-base-200 text-sm">
          {% for key, value in dataset.options.items %}
            <li><a class="cursor-default hover:bg-base-200">{{ value }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  {% if questions_using %}
    <h2>{% trans "Used in Questions" %}</h2>
    <div class="not-prose">
      <div class="overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>{% trans "Question" %}</th>
              <th>{% trans "Survey" %}</th>
              <th>{% trans "Group" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for question in questions_using %}
              <tr>
                <td>{{ question.question_text|truncatewords:10 }}</td>
                <td>
                  <a href="{% url 'surveys:groups' slug=question.question_group.survey.slug %}" class="link underline">
                    {{ question.question_group.survey.name }}
                  </a>
                </td>
                <td>{{ question.question_group.name }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <h2>{% trans "Usage" %}</h2>
    <p class="text-gray-600">{% trans "This dataset is not currently used in any questions." %}</p>
  {% endif %}

  <div class="not-prose mt-8">
    <a href="{% url 'surveys:dataset_list' %}" class="btn btn-ghost">
      ‚Üê {% trans "Back to Datasets" %}
    </a>
  </div>
</div>
{% endblock %}
