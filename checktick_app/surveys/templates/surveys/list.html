{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block title %}{% trans "Your Surveys" %} - CheckTick{% endblock %}
{% block content %}
<div class="prose max-w-none">
  {% include 'components/breadcrumbs.html' with crumb1_label='Surveys' crumb1_href='/surveys/' %}
  <h1 class="inline-flex items-center gap-2">
    {% include "components/icons/clipboard.html" with classes="w-6 h-6 text-base-content" %}
    <span>{% trans "Your Surveys" %}</span>
  </h1>

  {% if user.is_authenticated and tier_limits %}
    <!-- Tier limit information -->
    <div class="not-prose mb-4">
      {% if tier_limits.max_surveys is None %}
        <div class="alert alert-info">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span>{% trans "You have" %} {{ survey_count }} {% trans "surveys" %} ({% trans "unlimited on" %} {{ user_tier_display }})</span>
        </div>
      {% else %}
        {% if survey_count >= tier_limits.max_surveys %}
          <div class="alert alert-warning">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            <div>
              <div>{% trans "You've reached your survey limit:" %} {{ survey_count }}/{{ tier_limits.max_surveys }}</div>
              {% if not is_self_hosted %}
                <div class="text-sm">{% trans "Upgrade to Pro for unlimited surveys" %}</div>
              {% endif %}
            </div>
          </div>
        {% elif survey_count >= tier_limits.max_surveys|add:"-1" %}
          <div class="alert alert-warning">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            <div>
              <div>{% trans "Almost at your survey limit:" %} {{ survey_count }}/{{ tier_limits.max_surveys }}</div>
              {% if not is_self_hosted %}
                <div class="text-sm">{% trans "Upgrade to Pro for unlimited surveys" %}</div>
              {% endif %}
            </div>
          </div>
        {% else %}
          <div class="text-sm opacity-70 mb-2">{{ survey_count }}/{{ tier_limits.max_surveys }} {% trans "surveys used" %} ({{ user_tier_display }})</div>
        {% endif %}
      {% endif %}
    </div>
  {% endif %}

  {% if user.is_authenticated %}
    <p><a class="btn btn-primary not-prose" href="/surveys/create/">{% trans "Create survey" %}</a></p>
  {% endif %}

  {% if grouped_surveys %}
    {# Grouped survey display #}

    {# My Surveys (Owned) #}
    {% if grouped_surveys.owned %}
      <h2 class="text-xl font-semibold mt-8 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
        {% trans "My Surveys" %}
        <span class="badge badge-ghost">{{ grouped_surveys.owned|length }}</span>
      </h2>
      <ul class="not-prose w-full flex flex-col gap-3">
        {% for item in grouped_surveys.owned %}
          {% include "surveys/partials/survey_list_item.html" with item=item %}
        {% endfor %}
      </ul>
    {% endif %}

    {# Team Surveys #}
    {% for team_name, team_surveys in grouped_surveys.team.items %}
      <h2 class="text-xl font-semibold mt-8 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        {{ team_name }}
        <span class="badge badge-ghost">{{ team_surveys|length }}</span>
      </h2>
      <ul class="not-prose w-full flex flex-col gap-3">
        {% for item in team_surveys %}
          {% include "surveys/partials/survey_list_item.html" with item=item %}
        {% endfor %}
      </ul>
    {% endfor %}

    {# Organisation Surveys #}
    {% for org_name, org_surveys in grouped_surveys.organisation.items %}
      <h2 class="text-xl font-semibold mt-8 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
        </svg>
        {{ org_name }}
        <span class="badge badge-ghost">{{ org_surveys|length }}</span>
      </h2>
      <ul class="not-prose w-full flex flex-col gap-3">
        {% for item in org_surveys %}
          {% include "surveys/partials/survey_list_item.html" with item=item %}
        {% endfor %}
      </ul>
    {% endfor %}

    {# Shared with Me #}
    {% if grouped_surveys.shared %}
      <h2 class="text-xl font-semibold mt-8 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
        </svg>
        {% trans "Shared with Me" %}
        <span class="badge badge-ghost">{{ grouped_surveys.shared|length }}</span>
      </h2>
      <ul class="not-prose w-full flex flex-col gap-3">
        {% for item in grouped_surveys.shared %}
          {% include "surveys/partials/survey_list_item.html" with item=item %}
        {% endfor %}
      </ul>
    {% endif %}

    {# Empty state - no surveys anywhere #}
    {% if not grouped_surveys.owned and not grouped_surveys.team and not grouped_surveys.organisation and not grouped_surveys.shared %}
      <p class="mt-4">{% trans "No surveys yet." %}</p>
    {% endif %}

  {% elif surveys %}
    {# Fallback to flat list if grouped_surveys not available #}
    <ul class="not-prose w-full flex flex-col gap-3">
      {% for item in surveys_with_translations %}
        {% include "surveys/partials/survey_list_item.html" with item=item %}
      {% endfor %}
    </ul>
  {% else %}
    <p>{% trans "No surveys yet." %}</p>
  {% endif %}
</div>

<!-- Translation Creation Modal -->
<dialog id="translation_modal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold">{% trans "Create Translation" %}</h3>
    <p class="py-4">{% trans "This will create a copy of the survey in the selected language. The content will be automatically translated using AI, but you should review all translations before publishing." %}</p>

    <div class="form-control w-full">
      <label class="label">
        <span class="label-text">{% trans "Target Language" %}</span>
      </label>
      <select id="translation_language" class="select select-bordered w-full">
        <option value="">{% trans "Select a language..." %}</option>
        {% for code, name in supported_languages %}
          <option value="{{ code }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="alert alert-warning mt-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span>{% trans "AI translation may not be perfect. Always review content before publishing." %}</span>
    </div>

    <div class="modal-action">
      <button class="btn" onclick="translation_modal.close()">{% trans "Cancel" %}</button>
      <button id="create_translation_btn" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
        </svg>
        {% trans "Create Translation" %}
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>{% trans "close" %}</button>
  </form>
</dialog>

<!-- Translation Progress Modal -->
<dialog id="translation_progress_modal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold">{% trans "Creating Translation..." %}</h3>
    <div class="py-4">
      <progress class="progress progress-primary w-full"></progress>
      <p class="text-sm text-center mt-2" id="translation_status_text">{% trans "Translating survey content..." %}</p>
    </div>
  </div>
</dialog>

<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  let currentSurveySlug = null;
  let currentSurveyId = null;
  let existingLanguages = [];

  // Create Translation button functionality
  const createTranslationButtons = document.querySelectorAll('.create-translation-btn');
  const languageSelect = document.getElementById('translation_language');
  const allLanguageOptions = Array.from(languageSelect.querySelectorAll('option[value]')).map(opt => ({
    value: opt.value,
    text: opt.textContent
  }));

  createTranslationButtons.forEach(button => {
    button.addEventListener('click', function() {
      currentSurveySlug = this.dataset.surveySlug;
      currentSurveyId = this.dataset.surveyId;
      existingLanguages = (this.dataset.existingLanguages || '').split(',').filter(l => l);

      // Filter language options
      languageSelect.innerHTML = '<option value="">{% trans "Select a language..." %}</option>';
      allLanguageOptions.forEach(opt => {
        if (!existingLanguages.includes(opt.value)) {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.text;
          languageSelect.appendChild(option);
        }
      });

      translation_modal.showModal();
    });
  });

  // Handle translation creation
  document.getElementById('create_translation_btn').addEventListener('click', function() {
    const targetLanguage = document.getElementById('translation_language').value;

    if (!targetLanguage) {
      alert('{% trans "Please select a target language" %}');
      return;
    }

    // Close the selection modal and show progress modal
    translation_modal.close();
    translation_progress_modal.showModal();

    // Send translation request
    fetch(`/surveys/${currentSurveySlug}/translations/create/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        survey_id: currentSurveyId,
        target_language: targetLanguage
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.task_id) {
        pollTranslationStatus(data.task_id, currentSurveySlug);
      } else if (data.error) {
        translation_progress_modal.close();
        alert(data.error);
      }
    })
    .catch(error => {
      translation_progress_modal.close();
      alert('{% trans "Failed to create translation. Please try again." %}');
      console.error('Translation error:', error);
    });
  });

  function pollTranslationStatus(taskId, slug) {
    const interval = setInterval(() => {
      fetch(`/surveys/${slug}/translations/status/${taskId}/`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'completed') {
            clearInterval(interval);
            translation_progress_modal.close();
            location.reload(); // Reload to show new translation
          } else if (data.status === 'error') {
            clearInterval(interval);
            translation_progress_modal.close();
            alert('{% trans "Translation failed. Please try again or contact support." %}');
          }
          // Update status text if available
          if (data.message) {
            document.getElementById('translation_status_text').textContent = data.message;
          }
        })
        .catch(error => {
          clearInterval(interval);
          translation_progress_modal.close();
          console.error('Status polling error:', error);
        });
    }, 1000);
  }

  // Copy link functionality
  const copyButtons = document.querySelectorAll('.copy-survey-link');

  copyButtons.forEach(button => {
    button.addEventListener('click', function() {
      const url = this.dataset.url;
      const originalText = this.innerHTML;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => {
          // Show success feedback
          this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>{% trans "Copied!" %}';
          this.classList.add('btn-success');

          setTimeout(() => {
            this.innerHTML = originalText;
            this.classList.remove('btn-success');
          }, 2000);
        }).catch(() => {
          fallbackCopy(url, this, originalText);
        });
      } else {
        fallbackCopy(url, this, originalText);
      }
    });
  });

  function fallbackCopy(text, button, originalText) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();

    try {
      document.execCommand('copy');
      button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>{% trans "Copied!" %}';
      button.classList.add('btn-success');

      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
      }, 2000);
    } catch (err) {
      alert('{% trans "Failed to copy. Please copy manually:" %} ' + text);
    }

    document.body.removeChild(textarea);
  }
});
</script>
{% endblock %}
