{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block title %}{% trans "Your Surveys" %} - CheckTick{% endblock %}
{% block content %}
<div class="prose max-w-none">
  {% include 'components/breadcrumbs.html' with crumb1_label='Surveys' crumb1_href='/surveys/' %}
  <h1 class="inline-flex items-center gap-2">
    {% include "components/icons/clipboard.html" with classes="w-6 h-6 text-base-content" %}
    <span>{% trans "Your Surveys" %}</span>
  </h1>

  {% if user.is_authenticated and tier_limits %}
    <!-- Tier limit information -->
    <div class="not-prose mb-4">
      {% if tier_limits.max_surveys is None %}
        <div class="alert alert-info">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span>{% trans "You have" %} {{ survey_count }} {% trans "surveys" %} ({% trans "unlimited on" %} {{ user_tier_display }})</span>
        </div>
      {% else %}
        {% if survey_count >= tier_limits.max_surveys %}
          <div class="alert alert-warning">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            <div>
              <div>{% trans "You've reached your survey limit:" %} {{ survey_count }}/{{ tier_limits.max_surveys }}</div>
              {% if not is_self_hosted %}
                <div class="text-sm">{% trans "Upgrade to Pro for unlimited surveys" %}</div>
              {% endif %}
            </div>
          </div>
        {% elif survey_count >= tier_limits.max_surveys|add:"-1" %}
          <div class="alert alert-warning">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            <div>
              <div>{% trans "Almost at your survey limit:" %} {{ survey_count }}/{{ tier_limits.max_surveys }}</div>
              {% if not is_self_hosted %}
                <div class="text-sm">{% trans "Upgrade to Pro for unlimited surveys" %}</div>
              {% endif %}
            </div>
          </div>
        {% else %}
          <div class="text-sm opacity-70 mb-2">{{ survey_count }}/{{ tier_limits.max_surveys }} {% trans "surveys used" %} ({{ user_tier_display }})</div>
        {% endif %}
      {% endif %}
    </div>
  {% endif %}

  {% if user.is_authenticated %}
    <p><a class="btn btn-primary not-prose" href="/surveys/create/">{% trans "Create survey" %}</a></p>
  {% endif %}
  {% if surveys %}
  <ul class="not-prose w-full flex flex-col gap-3">
      {% for item in surveys_with_translations %}
        {% with s=item.survey %}
        <li class="w-full">
          <div class="w-full bg-base-100 rounded-lg border border-base-300 p-3 sm:p-4 hover:border-primary transition-colors">
            <div class="flex items-center gap-4 min-w-0">
              <div class="flex-shrink-0 inline-flex items-center justify-center">
                {% include "components/icons/checktick.html" with classes=brand.icon_size_class|default:'w-8 h-8' aria_label=brand.icon_alt|default:brand.title title=brand.icon_title|default:brand.title %}
              </div>
              <div class="min-w-0 w-full">
                <div class="flex items-center gap-2 min-w-0">
                  <a href="/surveys/{{ s.slug }}/dashboard/" class="font-medium leading-tight truncate link link-accent">{{ s.name }}</a>

                  <!-- Status badge (always primary) with language flags of that status -->
                  {% if s.status == 'published' %}
                    {# Base is published - show published languages #}
                    <span class="badge badge-primary badge-outline whitespace-nowrap flex items-center gap-1">
                      <span>{% trans "Published" %}</span>
                      <span class="text-base" title="{{ item.language_name }}">{{ item.flag }}</span>
                      {% for trans in item.translations %}
                        {% if trans.status == 'published' %}
                          <span class="text-base" title="{{ trans.language_name }}">{{ trans.flag }}</span>
                        {% endif %}
                      {% endfor %}
                    </span>
                  {% else %}
                    {# Base is draft - show base language and any other draft translations #}
                    <span class="badge badge-primary badge-outline whitespace-nowrap flex items-center gap-1">
                      <span>{% trans "Draft" %}</span>
                      <span class="text-base" title="{{ item.language_name }}">{{ item.flag }}</span>
                      {% for trans in item.translations %}
                        {% if trans.status == 'draft' %}
                          <span class="text-base" title="{{ trans.language_name }}">{{ trans.flag }}</span>
                        {% endif %}
                      {% endfor %}
                    </span>
                  {% endif %}

                  <!-- Draft translations badge - only show if base is published but translations are draft -->
                  {% if s.status == 'published' %}
                    {% regroup item.translations by status as translations_by_status %}
                    {% for status_group in translations_by_status %}
                      {% if status_group.grouper == 'draft' %}
                        <span class="badge badge-warning badge-outline whitespace-nowrap flex items-center gap-1">
                          <span>{% trans "Draft translations" %}</span>
                          {% for trans in status_group.list %}
                            <span class="text-base" title="{{ trans.language_name }}">{{ trans.flag }}</span>
                          {% endfor %}
                        </span>
                      {% endif %}
                    {% endfor %}
                  {% endif %}

                  {% if s.status == 'published' %}
                    {% with days=s.days_remaining %}
                      {% if days is None %}
                        <span class="badge badge-info badge-outline whitespace-nowrap">{% trans "No end date" %}</span>
                      {% elif days < 0 %}
                        <span class="badge badge-error badge-outline whitespace-nowrap">{% trans "Expired" %}</span>
                      {% elif days == 0 %}
                        <span class="badge badge-warning badge-outline whitespace-nowrap">{% trans "Ends today" %}</span>
                      {% elif days == 1 %}
                        <span class="badge badge-warning badge-outline whitespace-nowrap">{% trans "1 day remaining" %}</span>
                      {% elif days <= 7 %}
                        <span class="badge badge-warning badge-outline whitespace-nowrap">{{ days }} {% trans "days remaining" %}</span>
                      {% else %}
                        <span class="badge badge-success badge-outline whitespace-nowrap">{{ days }} {% trans "days remaining" %}</span>
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                </div>
                {% if s.description %}
                  <div class="text-sm opacity-70 truncate">{{ s.description }}</div>
                {% endif %}
              </div>
            </div>
            <div class="-mx-1 overflow-x-auto mt-3">
              <div class="px-1 min-w-max flex items-center gap-2">
                <a class="btn btn-secondary btn-sm" href="/surveys/{{ s.slug }}/dashboard/">
                  {% include "components/icons/clipboard.html" with classes="w-4 h-4 mr-1" %}
                  {% trans "Dashboard" %}
                </a>
                <a class="btn btn-outline btn-sm" href="{% url 'surveys:clone' slug=s.slug %}" title="{% trans 'Create a copy of this survey' %}">
                  {% include "components/icons/documents.html" with classes="w-4 h-4 mr-1" %}
                  {% trans "Create Copy" %}
                </a>
                {% if s.questions.count > 0 %}
                  <button class="btn btn-outline btn-sm create-translation-btn"
                          data-survey-slug="{{ s.slug }}"
                          data-survey-id="{{ s.id }}"
                          data-existing-languages="{{ s.language }}{% for trans in item.translations %},{{ trans.survey.language }}{% endfor %}"
                          title="{% trans 'Create a translation of this survey' %}">
                    {% include "components/icons/language.html" with classes="w-4 h-4 mr-1" %}
                    {% trans "Create Translation" %}
                  </button>
                {% else %}
                  <button class="btn btn-outline btn-sm btn-disabled" aria-disabled="true" title="{% trans 'Add questions before creating translation' %}">
                    {% include "components/icons/language.html" with classes="w-4 h-4 mr-1" %}
                    {% trans "Create Translation" %}
                  </button>
                {% endif %}
                <a class="btn btn-secondary btn-sm{% if s.questions.count == 0 %} btn-disabled{% endif %}" href="{% if s.questions.count > 0 %}/surveys/{{ s.slug }}/preview/{% else %}#{% endif %}"{% if s.questions.count == 0 %} aria-disabled="true" title="{% trans 'Add questions before previewing' %}"{% endif %}>
                  {% include "components/icons/building.html" with classes="w-4 h-4 mr-1" %}
                  {% trans "Preview" %}
                </a>
                {% if s.status == 'draft' %}
                  <a class="btn btn-success btn-sm{% if s.questions.count == 0 %} btn-disabled{% endif %}" href="{% if s.questions.count > 0 %}{% url 'surveys:publish_settings' slug=s.slug %}{% else %}#{% endif %}"{% if s.questions.count == 0 %} aria-disabled="true" title="{% trans 'Add questions before publishing' %}"{% endif %}>
                    {% include "components/icons/cloud-upload.html" with classes="w-4 h-4 mr-1" %}
                    {% trans "Publish" %}
                  </a>
                {% elif s.status == 'published' %}
                  <a class="btn btn-primary btn-sm{% if s.questions.count == 0 %} btn-disabled{% endif %}" href="{% if s.questions.count > 0 %}{% url 'surveys:publish_settings' slug=s.slug %}{% else %}#{% endif %}"{% if s.questions.count == 0 %} aria-disabled="true" title="{% trans 'Add questions before publishing' %}"{% endif %}>
                    {% include "components/icons/pencil.html" with classes="w-4 h-4 mr-1" %}
                    {% trans "Edit Publication" %}
                  </a>
                {% endif %}
                {% if s.status == 'published' %}
                  {% if s.visibility == 'public' %}
                    <button class="btn btn-outline btn-sm copy-survey-link" data-slug="{{ s.slug }}" data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ s.slug }}/take/">
                      {% include "components/icons/documents.html" with classes="w-4 h-4 mr-1" %}
                      {% trans "Copy Link" %}
                    </button>
                  {% elif s.visibility == 'unlisted' and s.unlisted_key %}
                    <button class="btn btn-outline btn-sm copy-survey-link" data-slug="{{ s.slug }}" data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ s.slug }}/take/unlisted/{{ s.unlisted_key }}/">
                      {% include "components/icons/documents.html" with classes="w-4 h-4 mr-1" %}
                      {% trans "Copy Link" %}
                    </button>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
        </li>
        {% endwith %}
      {% endfor %}
    </ul>
  {% else %}
    <p>{% trans "No surveys yet." %}</p>
  {% endif %}
</div>

<!-- Translation Creation Modal -->
<dialog id="translation_modal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold">{% trans "Create Translation" %}</h3>
    <p class="py-4">{% trans "This will create a copy of the survey in the selected language. The content will be automatically translated using AI, but you should review all translations before publishing." %}</p>

    <div class="form-control w-full">
      <label class="label">
        <span class="label-text">{% trans "Target Language" %}</span>
      </label>
      <select id="translation_language" class="select select-bordered w-full">
        <option value="">{% trans "Select a language..." %}</option>
        {% for code, name in supported_languages %}
          <option value="{{ code }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="alert alert-warning mt-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span>{% trans "AI translation may not be perfect. Always review content before publishing." %}</span>
    </div>

    <div class="modal-action">
      <button class="btn" onclick="translation_modal.close()">{% trans "Cancel" %}</button>
      <button id="create_translation_btn" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
        </svg>
        {% trans "Create Translation" %}
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>{% trans "close" %}</button>
  </form>
</dialog>

<!-- Translation Progress Modal -->
<dialog id="translation_progress_modal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold">{% trans "Creating Translation..." %}</h3>
    <div class="py-4">
      <progress class="progress progress-primary w-full"></progress>
      <p class="text-sm text-center mt-2" id="translation_status_text">{% trans "Translating survey content..." %}</p>
    </div>
  </div>
</dialog>

<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  let currentSurveySlug = null;
  let currentSurveyId = null;
  let existingLanguages = [];

  // Create Translation button functionality
  const createTranslationButtons = document.querySelectorAll('.create-translation-btn');
  const languageSelect = document.getElementById('translation_language');
  const allLanguageOptions = Array.from(languageSelect.querySelectorAll('option[value]')).map(opt => ({
    value: opt.value,
    text: opt.textContent
  }));

  createTranslationButtons.forEach(button => {
    button.addEventListener('click', function() {
      currentSurveySlug = this.dataset.surveySlug;
      currentSurveyId = this.dataset.surveyId;
      existingLanguages = (this.dataset.existingLanguages || '').split(',').filter(l => l);

      // Filter language options
      languageSelect.innerHTML = '<option value="">{% trans "Select a language..." %}</option>';
      allLanguageOptions.forEach(opt => {
        if (!existingLanguages.includes(opt.value)) {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.text;
          languageSelect.appendChild(option);
        }
      });

      translation_modal.showModal();
    });
  });

  // Handle translation creation
  document.getElementById('create_translation_btn').addEventListener('click', function() {
    const targetLanguage = document.getElementById('translation_language').value;

    if (!targetLanguage) {
      alert('{% trans "Please select a target language" %}');
      return;
    }

    // Close the selection modal and show progress modal
    translation_modal.close();
    translation_progress_modal.showModal();

    // Send translation request
    fetch(`/surveys/${currentSurveySlug}/translations/create/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        survey_id: currentSurveyId,
        target_language: targetLanguage
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.task_id) {
        pollTranslationStatus(data.task_id, currentSurveySlug);
      } else if (data.error) {
        translation_progress_modal.close();
        alert(data.error);
      }
    })
    .catch(error => {
      translation_progress_modal.close();
      alert('{% trans "Failed to create translation. Please try again." %}');
      console.error('Translation error:', error);
    });
  });

  function pollTranslationStatus(taskId, slug) {
    const interval = setInterval(() => {
      fetch(`/surveys/${slug}/translations/status/${taskId}/`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'completed') {
            clearInterval(interval);
            translation_progress_modal.close();
            location.reload(); // Reload to show new translation
          } else if (data.status === 'error') {
            clearInterval(interval);
            translation_progress_modal.close();
            alert('{% trans "Translation failed. Please try again or contact support." %}');
          }
          // Update status text if available
          if (data.message) {
            document.getElementById('translation_status_text').textContent = data.message;
          }
        })
        .catch(error => {
          clearInterval(interval);
          translation_progress_modal.close();
          console.error('Status polling error:', error);
        });
    }, 1000);
  }

  // Copy link functionality
  const copyButtons = document.querySelectorAll('.copy-survey-link');

  copyButtons.forEach(button => {
    button.addEventListener('click', function() {
      const url = this.dataset.url;
      const originalText = this.innerHTML;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => {
          // Show success feedback
          this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>{% trans "Copied!" %}';
          this.classList.add('btn-success');

          setTimeout(() => {
            this.innerHTML = originalText;
            this.classList.remove('btn-success');
          }, 2000);
        }).catch(() => {
          fallbackCopy(url, this, originalText);
        });
      } else {
        fallbackCopy(url, this, originalText);
      }
    });
  });

  function fallbackCopy(text, button, originalText) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();

    try {
      document.execCommand('copy');
      button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>{% trans "Copied!" %}';
      button.classList.add('btn-success');

      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
      }, 2000);
    } catch (err) {
      alert('{% trans "Failed to copy. Please copy manually:" %} ' + text);
    }

    document.body.removeChild(textarea);
  }
});
</script>
{% endblock %}
