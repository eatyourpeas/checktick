repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: end-of-file-fixer
      - id: trailing-whitespace

  # Semgrep - catches security issues similar to CodeQL (XSS, injection, etc.)
  - repo: https://github.com/semgrep/semgrep
    rev: v1.102.0
    hooks:
      - id: semgrep
        name: Semgrep security scan
        args:
          - --config=p/python
          - --config=p/django
          - --config=p/security-audit
          - --error
          - --quiet
        # Only run on changed Python files for speed
        types: [python]
        # Skip test files (less critical for security)
        exclude: ^tests/

  # Check for hardcoded passwords in Python test files (only in new commits)
  - repo: local
    hooks:
      - id: check-test-passwords
        name: Check for hardcoded passwords in tests
        entry: python3
        language: system
        files: 'test.*\.py$'
        args:
          - -c
          - |
            import sys, re
            pattern = re.compile(r'password\s*=\s*["\'][a-zA-Z0-9]{4,}["\']')
            for filepath in sys.argv[1:]:
                with open(filepath) as f:
                    content = f.read()
                    # Skip if file uses TEST_PASSWORD constant
                    if 'TEST_PASSWORD' in content:
                        continue
                    # Check for hardcoded passwords
                    matches = pattern.findall(content)
                    if matches:
                        print(f'‚ùå {filepath}: Found hardcoded password: {matches[0]}')
                        print('   Use TEST_PASSWORD = "x" constant instead.')
                        sys.exit(1)
            sys.exit(0)

  - repo: https://github.com/GitGuardian/ggshield
    rev: v1.43.0
    hooks:
      - id: ggshield
        name: ggshield secret scan (pre-commit)
        args: ["secret", "scan", "pre-commit", "--verbose"]
        stages: [pre-commit]
      - id: ggshield
        name: ggshield secret scan (pre-push)
        args: ["secret", "scan", "pre-push", "--verbose"]
        stages: [pre-push]

  # Dependency vulnerability scanning (runs on push only, can be slow)
  # Note: Use s/security-audit for local checks; CI runs pip-audit in GitHub Actions
  - repo: local
    hooks:
      - id: pip-audit
        name: Check for vulnerable dependencies
        entry: bash -c 'echo "Dependency scanning runs in CI (see .github/workflows/security.yml)" && echo "Run s/security-audit for local checks"'
        language: system
        pass_filenames: false
        files: ^(pyproject\.toml|poetry\.lock)$
        stages: [pre-push]
        always_run: false
